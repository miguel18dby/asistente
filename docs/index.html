<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Espacio Inteligente</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary-bg: #0a0e27;
            --secondary-bg: #1a1f3a;
            --accent-color: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --hover-bg: #252b4a;
            --card-bg: #1e2347;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff4757;
            --border-color: #30375a;
        }
        [data-theme="light"] {
            --primary-bg: #f8fafc;
            --secondary-bg: #ffffff;
            --accent-color: #3b82f6;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --hover-bg: #e2e8f0;
            --card-bg: #ffffff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --border-color: #cbd5e1;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            font-size: 16px;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--secondary-bg);
            padding: 2rem 0;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        .sidebar.show {
            transform: translateX(0);
        }
        .logo {
            text-align: center;
            margin-bottom: 2rem;
            padding: 0 1.5rem;
        }
        .logo h2 {
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .nav-menu {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
        }
        .nav-item {
            margin: 0.25rem 0;
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.9rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
            font-weight: 500;
        }
        .nav-link:hover,
        .nav-link.active {
            background: var(--hover-bg);
            color: var(--text-primary);
            border-left-color: var(--accent-color);
        }
        .nav-link.active {
            color: var(--accent-color);
        }
        .nav-link i {
            margin-right: 1rem;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            transition: margin-left 0.3s ease;
        }
        .main-content.expanded {
            margin-left: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .menu-toggle {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            transition: background-color 0.2s ease;
        }
        .menu-toggle:hover {
            background-color: var(--success-color);
        }
        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .theme-toggle,
        .lang-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .theme-toggle:hover,
        .lang-toggle:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
            border-color: var(--accent-color);
        }
        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .content-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Home Section */
        .hero {
            text-align: center;
            padding: 3rem 1rem;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), transparent);
            border-radius: 20px;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color);
        }
        .hero h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        .hero p {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .cta-button, .ai-tip-button {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
            padding: 0.9rem 2.2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
            margin-top: 1rem;
        }
         .ai-tip-button .fas {
            margin-right: 0.5em;
        }
        .cta-button:hover, .ai-tip-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 212, 255, 0.3);
        }
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .card {
            background: var(--card-bg);
            padding: 1.8rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
            border-color: var(--accent-color);
        }
        .card-icon {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
            line-height: 1;
        }
        .card h3 {
            font-size: 1.3rem;
            margin-bottom: 0.8rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        .card p {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
            flex-grow: 1;
        }
        /* Folders Section & Files Section (estilos compartidos para grids) */
        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.7rem 1.3rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            font-size: 0.95rem;
        }
         .btn .fas {
            margin-right: 0.3em;
        }
        .btn:hover {
            background: var(--success-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
        }
        .folders-grid, .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
        }
        /* Estilos para vista de lista */
        .folders-grid.list-view, .files-grid.list-view {
            grid-template-columns: 1fr;
        }
        .folders-grid.list-view .folder-item,
        .files-grid.list-view .file-item {
            text-align: left;
            display: flex;
            align-items: center;
            padding: 1rem;
            position: relative; /* Para el botón de borrar */
        }
        .files-grid.list-view .file-item .delete-file-icon {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            padding: 0.5rem;
        }
        .folders-grid.list-view .folder-icon,
        .files-grid.list-view .file-icon {
            font-size: 1.5rem;
            margin-bottom: 0;
            margin-right: 1rem;
        }
        .folders-grid.list-view .folder-name,
        .files-grid.list-view .file-name {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .folders-grid.list-view .folder-stats,
        .files-grid.list-view .file-size {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-right: 2.5rem; /* Espacio para el botón de borrar */
        }
        .folder-item, .file-item {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative; /* Para el botón de borrar en vista grid */
        }
        .file-item .delete-file-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: var(--danger-color);
            background-color: rgba(0,0,0,0.2);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .file-item:hover .delete-file-icon {
            opacity: 1;
        }
        .file-item .delete-file-icon:hover {
            background-color: var(--danger-color);
            color: white;
        }
        .folder-item:hover, .file-item:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .folder-icon, .file-icon {
            font-size: 2.8rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        .folder-name, .file-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .folder-stats, .file-size {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--accent-color);
            border-radius: 15px;
            padding: 2.5rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
            background: rgba(0, 212, 255, 0.03);
            cursor: pointer;
        }
        .drop-zone.dragover {
            background: rgba(0, 212, 255, 0.08);
            border-color: var(--success-color);
            transform: scale(1.02);
        }
        .drop-zone i {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        .drop-zone h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .drop-zone p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        /* Notes Section */
        .notes-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 12rem);
            min-height: 500px;
        }
        .notes-list {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1rem;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .notes-list h3 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.1rem;
        }
        .note-item {
            padding: 0.9rem;
            margin-bottom: 0.5rem;
            background: var(--hover-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .note-item:hover {
            background: var(--primary-bg);
            border-color: var(--accent-color);
        }
        .note-item.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .note-item.active strong, .note-item.active div {
            color: white !important;
        }
        .note-item.active .pin-note, .note-item.active .delete-note-icon {
            color: white !important;
        }
        .note-editor {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .editor-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 40px;
        }
         .editor-btn .fas, .editor-btn .ai-icon {
            margin-right: 0.3em;
        }
        .editor-btn:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
        }
        .note-title {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 2px solid var(--border-color);
            outline: none;
            width: 100%;
        }
        .note-title:focus {
            border-bottom-color: var(--accent-color);
        }
        .note-content {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.7;
            resize: none;
            outline: none;
            padding: 0.5rem 0;
            width: 100%;
        }
        /* Calendar Section */
        .calendar-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid var(--border-color);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .calendar-nav {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        .calendar-nav:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .calendar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .calendar-day {
            background: var(--card-bg);
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-weight: 500;
            position: relative;
        }
        .calendar-day.calendar-header-day {
            background: var(--secondary-bg);
            color: var(--text-secondary);
            font-weight: bold;
            cursor: default;
            min-height: auto;
            padding: 0.5rem;
        }
        .calendar-day:hover:not(.calendar-header-day):not(.empty) {
            background: var(--hover-bg);
        }
        .calendar-day.empty {
            background: var(--secondary-bg);
            cursor: default;
        }
        .calendar-day.today {
            background: var(--accent-color);
            color: white;
            font-weight: bold;
            border-radius: 4px;
        }
        .calendar-day.today:hover {
            background: var(--success-color);
        }
        .calendar-day.has-events .event-indicator {
            width: 8px;
            height: 8px;
            background-color: var(--danger-color);
            border-radius: 50%;
            display: inline-block;
            margin-top: 0.3rem;
        }
        .calendar-day.today.has-events .event-indicator {
            background-color: white;
        }
        /* Files Section Specifics */
        .files-header {
            /* ... */
        }
        .search-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 25px;
            outline: none;
            min-width: 250px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .search-box:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .filter-btn.active,
        .filter-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        /* Settings Section */
        .settings-container {
            max-width: 700px;
            margin: 0 auto;
        }
        .settings-group {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        .settings-group h3 {
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        .setting-control {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--hover-bg);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .toggle-switch.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        .dropdown {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            outline: none;
            min-width: 150px;
        }
        .dropdown:focus {
            border-color: var(--accent-color);
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            animation: fadeInModal 0.3s ease-out;
            overflow-y: auto;
            padding: 1rem;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            max-width: 550px;
            width: 100%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideInModal 0.3s ease-out;
            border: 1px solid var(--border-color);
        }
        @keyframes slideInModal {
            from { transform: translateY(-30px) scale(0.95); opacity: 0.5; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0.5rem;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--danger-color);
        }
        .modal-title {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group:last-child {
            margin-bottom: 0;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }
        .form-input, .form-textarea {
            width: 100%;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.8rem;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s ease;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-input:focus, .form-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
            background: var(--primary-bg);
        }
        .form-input[type="date"], .form-input[type="time"] {
            color-scheme: var(--current-theme, dark);
        }
        body[data-theme="light"] .form-input[type="date"],
        body[data-theme="light"] .form-input[type="time"] {
            color-scheme: light;
        }
        /* Database Connection Status */
        .db-status {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--card-bg);
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            border-left: 4px solid var(--warning-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .db-status.connected {
            border-left-color: var(--success-color);
        }
        .db-status.connected i {
            color: var(--success-color);
        }
        .db-status i {
            color: var(--warning-color);
        }
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            font-weight: 500;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateX(120%);
            opacity: 0;
        }
        .notification.slide-in {
            transform: translateX(0);
            opacity: 1;
        }
        .notification.slide-out {
            transform: translateX(120%);
            opacity: 0;
        }
        .notification.success { background: var(--success-color); }
        .notification.error   { background: var(--danger-color); }
        .notification.warning { background: var(--warning-color); }
        .notification.info    { background: var(--accent-color); }

        /* Modal de Confirmación Personalizado y File Preview Modal */
        .custom-confirm-modal .modal-content,
        #filePreviewModal .modal-content,
        #tipModal .modal-content {
            max-width: 450px;
        }
        #filePreviewModal .modal-content {
            max-width: 80vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        #filePreviewModal .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        #filePreviewImage, #filePreviewVideo, #filePreviewIframe { /* Cambiado embed a iframe */
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            margin: auto; 
            border: none; 
        }
         #filePreviewAudio {
            width: 100%;
        }
        #filePreviewText {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 8px;
            max-height: 70vh;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
            width: 100%;
        }
        /* Event Notification Modal */
        #eventNotificationModal .modal-content {
            border-left: 5px solid var(--accent-color);
        }
        #eventNotificationModal .event-time {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        #eventNotificationModal .event-description {
            margin-top: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }


        /* Responsive Design */
        @media (max-width: 992px) {
            .notes-container {
                grid-template-columns: 220px 1fr;
            }
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: none;
            }
            .sidebar.show {
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                width: 250px;
            }
            .main-content {
                margin-left: 0;
                padding: 1.5rem;
            }
            .menu-toggle {
                display: block;
            }
            .header-title {
                font-size: 1.5rem;
            }
            .header-controls {
                gap: 0.5rem;
            }
            .theme-toggle, .lang-toggle {
                padding: 0.6rem;
            }
            .lang-toggle span { display: none; }
            .cards-grid {
                grid-template-columns: 1fr;
            }
            .notes-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .notes-list {
                max-height: 250px;
                margin-bottom: 1rem;
            }
            .calendar-day {
                min-height: 50px;
                font-size: 0.85rem;
                padding: 0.5rem;
            }
            .calendar-day.calendar-header-day {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
            .files-header, .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .search-box {
                min-width: auto;
                width: 100%;
            }
            .filter-buttons {
                justify-content: center;
            }
            .settings-container {
                padding: 0 0.5rem;
            }
            .settings-group {
                padding: 1.5rem;
            }
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
            #filePreviewModal .modal-content {
                max-width: 90vw;
                max-height: 85vh;
            }
            .db-status {
                bottom: 1rem;
                right: 1rem;
                padding: 0.6rem 1rem;
            }
            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                text-align: center;
            }
        }
        /* Animaciones Adicionales */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.98); }
        }
        .loading-indicator {
            animation: pulse 1.5s infinite ease-in-out;
        }
        /* Loading Overlay for Gemini API */
        .loading-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9998; /* Below modals but above most content */
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-overlay .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            width: 50px;
            height: 50px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <h2><i class="fas fa-brain"></i> Mi Espacio IA</h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="home">
                        <i class="fas fa-home"></i>
                        <span data-translate="nav.home">Inicio</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="folders">
                        <i class="fas fa-folder"></i>
                        <span data-translate="nav.folders">Mis Carpetas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="notes">
                        <i class="fas fa-sticky-note"></i>
                        <span data-translate="nav.notes">Bloc de Notas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="calendar">
                        <i class="fas fa-calendar"></i>
                        <span data-translate="nav.calendar">Calendario</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="files">
                        <i class="fas fa-file"></i>
                        <span data-translate="nav.files">Archivos Subidos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span data-translate="nav.settings">Configuración</span>
                    </a>
                </li>
            </ul>
        </nav>
        <main class="main-content" id="mainContent">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title" data-translate="header.title">Mi Espacio Inteligente</h1>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="lang-toggle" id="langToggle">
                        <i class="fas fa-globe"></i> <span id="langToggleText">ES</span>
                    </button>
                </div>
            </header>
            <section class="content-section active" id="home">
                <div class="hero">
                    <h1 data-translate="home.title">Bienvenido a tu Espacio Inteligente</h1>
                    <p data-translate="home.subtitle">Donde la inteligencia artificial se encuentra con tu productividad personal</p>
                    <button class="cta-button" onclick="showSection('folders')" data-translate="home.cta">
                        Comenzar Ahora
                    </button>
                    <button class="ai-tip-button" id="dailyTipBtn">
                        <i class="fas fa-lightbulb"></i> <span data-translate="home.aiTip">Consejo del Día</span>
                    </button>
                </div>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <h3 data-translate="home.cards.folders.title">Gestión de Carpetas</h3>
                        <p data-translate="home.cards.folders.desc">Organiza tus archivos de manera inteligente con carpetas personalizadas y clasificación automática.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <h3 data-translate="home.cards.notes.title">Notas Inteligentes</h3>
                        <p data-translate="home.cards.notes.desc">Crea, edita y organiza tus ideas con un editor enriquecido y sugerencias de IA.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <h3 data-translate="home.cards.calendar.title">Calendario Personal</h3>
                        <p data-translate="home.cards.calendar.desc">Planifica tu día con recordatorios inteligentes y gestión avanzada de eventos.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3 data-translate="home.cards.ai.title">Asistente IA</h3>
                        <p data-translate="home.cards.ai.desc">Tu compañero inteligente para responder preguntas y sugerir mejoras en tu flujo de trabajo.</p>
                    </div>
                </div>
            </section>
            <section class="content-section" id="folders">
                <div class="toolbar">
                    <button class="btn" onclick="createFolder()">
                        <i class="fas fa-plus"></i>
                        <span data-translate="folders.create">Nueva Carpeta</span>
                    </button>
                    <button class="btn btn-secondary" onclick="uploadFile()">
                        <i class="fas fa-upload"></i>
                        <span data-translate="folders.upload">Subir Archivo</span>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleView()">
                        <i class="fas fa-th" id="viewIcon"></i>
                        <span data-translate="folders.view">Vista</span>
                    </button>
                </div>
                <div class="drop-zone" id="dropZone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3 data-translate="folders.dropzone.title">Arrastra y suelta tus archivos aquí</h3>
                    <p data-translate="folders.dropzone.desc">O haz clic para seleccionar archivos</p>
                </div>
                <div class="folders-grid" id="foldersGrid">
                    </div>
            </section>
            <section class="content-section" id="notes">
                <div class="toolbar">
                    <button class="btn" onclick="createNote()">
                        <i class="fas fa-plus"></i>
                        <span data-translate="notes.create">Nueva Nota</span>
                    </button>
                    <button class="btn btn-secondary" onclick="saveNote()">
                        <i class="fas fa-save"></i>
                        <span data-translate="notes.save">Guardar</span>
                    </button>
                    <button class="btn btn-secondary" onclick="deleteNote()">
                        <i class="fas fa-trash"></i>
                        <span data-translate="notes.delete">Eliminar</span>
                    </button>
                </div>
                <div class="notes-container">
                    <div class="notes-list">
                        <h3 data-translate="notes.list.title">Mis Notas</h3>
                        <div id="notesList">
                            </div>
                    </div>
                    <div class="note-editor">
                        <div class="editor-toolbar">
                            <button class="editor-btn" onclick="formatText('bold')">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button class="editor-btn" onclick="formatText('italic')">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button class="editor-btn" onclick="formatText('underline')">
                                <i class="fas fa-underline"></i>
                            </button>
                            <button class="editor-btn" onclick="insertList()">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="editor-btn" id="summarizeNoteBtn" title="Resumir Nota con IA">
                                <i class="fas fa-star ai-icon"></i> <span data-translate="notes.summarize">Resumir</span>
                            </button>
                            <button class="editor-btn" id="continueWritingBtn" title="Continuar Escritura con IA">
                                <i class="fas fa-pen-fancy ai-icon"></i> <span data-translate="notes.continue">Continuar</span>
                            </button>
                        </div>
                        <input type="text" class="note-title" id="noteTitle" placeholder="Título de la nota..." data-translate="notes.title.placeholder" data-translate-placeholder="notes.title.placeholder">
                        <textarea class="note-content" id="noteContent" placeholder="Escribe tu nota aquí..." data-translate="notes.content.placeholder" data-translate-placeholder="notes.content.placeholder"></textarea>
                    </div>
                </div>
            </section>
            <section class="content-section" id="calendar">
                <div class="toolbar">
                    <button class="btn" onclick="addEvent()">
                        <i class="fas fa-plus"></i>
                        <span data-translate="calendar.addEvent">Nuevo Evento</span>
                    </button>
                    <button class="btn btn-secondary" onclick="todayView()">
                        <i class="fas fa-calendar-day"></i>
                        <span data-translate="calendar.today">Hoy</span>
                    </button>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 class="calendar-title" id="calendarTitle">Enero 2024</h2>
                        <button class="calendar-nav" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        </div>
                </div>
            </section>
            <section class="content-section" id="files">
                <div class="files-header">
                    <input type="text" class="search-box" placeholder="Buscar archivos..." data-translate="files.search.placeholder" data-translate-placeholder="files.search.placeholder" id="fileSearch">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-translate="files.filter.all">Todos</button>
                        <button class="filter-btn" data-filter="image" data-translate="files.filter.images">Imágenes</button>
                        <button class="filter-btn" data-filter="document" data-translate="files.filter.documents">Documentos</button>
                        <button class="filter-btn" data-filter="video" data-translate="files.filter.videos">Videos</button>
                        <button class="filter-btn" data-filter="audio" data-translate="files.filter.audio">Audio</button>
                    </div>
                </div>
                <div class="files-grid" id="filesGrid">
                    </div>
            </section>
            <section class="content-section" id="settings">
                <div class="settings-container">
                    <div class="settings-group">
                        <h3 data-translate="settings.appearance.title">Apariencia</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.appearance.theme">Modo Oscuro</span>
                            <div class="setting-control">
                                <div class="toggle-switch active" id="darkModeToggle">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.appearance.font">Tamaño de Fuente</span>
                            <div class="setting-control">
                                <select class="dropdown" id="fontSizeSelect">
                                    <option value="small" data-translate="settings.appearance.font.small">Pequeño</option>
                                    <option value="medium" selected data-translate="settings.appearance.font.medium">Mediano</option>
                                    <option value="large" data-translate="settings.appearance.font.large">Grande</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3 data-translate="settings.language.title">Idioma</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.language.select">Idioma de la Interfaz</span>
                            <div class="setting-control">
                                <select class="dropdown" id="languageSelect">
                                    <option value="es" data-translate="settings.language.spanish">Español</option>
                                    <option value="en" data-translate="settings.language.english">English</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3 data-translate="settings.ai.title">Configuración de IA</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.ai.suggestions">Sugerencias Automáticas</span>
                            <div class="setting-control">
                                <div class="toggle-switch active" id="aiSuggestionsToggle">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.ai.voice">Reconocimiento de Voz</span>
                            <div class="setting-control">
                                <div class="toggle-switch" id="voiceToggle">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3 data-translate="settings.database.title">Configuración de Base de Datos</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.database.status">Estado de Conexión</span>
                            <div class="setting-control">
                                <span id="dbConnectionStatus" class="badge" style="color: var(--warning-color);">
                                    <i class="fas fa-exclamation-triangle"></i> <span data-translate="settings.database.status.pending">Pendiente de Configuración</span>
                                </span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.database.config">Configurar Conexión</span>
                            <div class="setting-control">
                                <button class="btn btn-secondary" onclick="showDatabaseConfig()">
                                    <i class="fas fa-database"></i> <span data-translate="settings.database.config.button">Configurar</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <div class="modal" id="folderModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('folderModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title" data-translate="modal.folder.title">Nueva Carpeta</h3>
            <div class="form-group">
                <label class="form-label" data-translate="modal.folder.name">Nombre de la carpeta:</label>
                <input type="text" class="form-input" id="folderNameInput" placeholder="Mi nueva carpeta" data-translate-placeholder="modal.folder.name.placeholder">
            </div>
            <div class="form-group">
                <button class="btn" onclick="confirmCreateFolder()">
                    <i class="fas fa-check"></i>
                    <span data-translate="modal.folder.create">Crear Carpeta</span>
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('eventModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title" data-translate="modal.event.title">Nuevo Evento</h3>
            <div class="form-group">
                <label class="form-label" data-translate="modal.event.name">Título del evento:</label>
                <input type="text" class="form-input" id="eventTitleInput" placeholder="Mi evento" data-translate-placeholder="modal.event.name.placeholder">
            </div>
            <div class="form-group">
                <label class="form-label" for="eventDescriptionInput" data-translate="modal.event.description">Descripción:</label>
                <textarea id="eventDescriptionInput" class="form-textarea" placeholder="Describe tu evento..." data-translate-placeholder="modal.event.description.placeholder"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" data-translate="modal.event.date">Fecha:</label>
                <input type="date" class="form-input" id="eventDateInput">
            </div>
            <div class="form-group">
                <label class="form-label" data-translate="modal.event.time">Hora:</label>
                <input type="time" class="form-input" id="eventTimeInput">
            </div>
            <div class="form-group">
                <button class="btn" onclick="confirmAddEvent()">
                    <i class="fas fa-check"></i>
                    <span data-translate="modal.event.create">Crear Evento</span>
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="databaseModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('databaseModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title" data-translate="modal.database.title">Configuración de Base de Datos</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;" data-translate="modal.database.desc">
                Para conectar tu base de datos Supabase, necesitas añadir tu URL de Supabase y tu Clave Anónima (Anon Key)
                directamente en las constantes `SUPABASE_URL` y `SUPABASE_ANON_KEY` al inicio del bloque de código JavaScript.
            </p>
             <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Ejemplo:
                <br>
                <code>const SUPABASE_URL = 'https://tu-proyecto-id.supabase.co';</code>
                <br>
                <code>const SUPABASE_ANON_KEY = 'tu-clave-anon';</code>
            </p>
            <div class="form-group">
                <button class="btn" onclick="closeModal('databaseModal')">
                    <i class="fas fa-check"></i>
                    <span data-translate="modal.database.connect">Entendido</span>
                </button>
            </div>
        </div>
    </div>
     <div class="modal" id="tipModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('tipModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title" id="tipModalTitle" data-translate="modal.tip.title">✨ Consejo del Día</h3>
            <p id="tipModalContent" style="color: var(--text-secondary); line-height: 1.6;" data-translate="modal.tip.loading">Cargando consejo...</p>
        </div>
    </div>
    <div class="modal" id="filePreviewModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('filePreviewModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title" id="filePreviewTitle" data-translate="modal.filePreview.title">Vista Previa de Archivo</h3>
            <div class="modal-body" id="filePreviewBody" style="text-align: center;">
                <img id="filePreviewImage" src="#" alt="Previsualización de Imagen" style="display:none; max-width:100%; max-height: 70vh; object-fit: contain; margin: auto;">
                <video id="filePreviewVideo" src="#" style="display:none; max-width:100%; max-height: 70vh; margin: auto;" controls></video>
                <audio id="filePreviewAudio" src="#" style="display:none; width:100%; margin-top: 1rem;" controls></audio>
                <iframe id="filePreviewIframe" style="display:none; width:100%; height:70vh; border:none;"></iframe>
                <pre id="filePreviewText" style="display:none; white-space:pre-wrap; word-wrap:break-word; max-height: 70vh; overflow-y:auto; background: var(--hover-bg); padding: 1rem; border-radius: 8px; text-align: left;"></pre>
                <p id="filePreviewFallback" style="display:none; padding: 1rem; color: var(--text-secondary);"></p>
            </div>
            <div class="form-group" style="margin-top: 1.5rem; text-align: right;">
                <a href="#" id="fileDownloadLink" class="btn btn-secondary" download>
                    <i class="fas fa-download"></i> <span data-translate="modal.filePreview.download">Descargar</span>
                </a>
            </div>
        </div>
    </div>
    <div class="modal" id="eventNotificationModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('eventNotificationModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title" id="eventNotificationTitle" data-translate="modal.eventNotification.title">🔔 ¡Recordatorio de Evento!</h3>
            <p id="eventNotificationTime" class="event-time"></p>
            <p id="eventNotificationDescription" class="event-description"></p>
            <div class="form-group" style="margin-top: 1.5rem; text-align: right;">
                 <button class="btn" onclick="closeModal('eventNotificationModal')" data-translate="modal.eventNotification.close">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="db-status" id="dbStatus">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-database"></i>
            <span data-translate="db.status.pending">Base de Datos: Pendiente</span>
        </div>
    </div>
    <input type="file" id="fileInput" multiple style="display: none;">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    <script>
        // --- Configuración de Supabase ---
        const SUPABASE_URL = 'https://kuzctbrowwnrwvpvqnky.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1emN0YnJvd3ducnd2cHZxbmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNzAxMDYsImV4cCI6MjA2Mzg0NjEwNn0.52DbeVnoMpGf1OsagJAsgNjje4oC4N2vunBE41uELpw';
        // --- Fin de Configuración de Supabase ---

        let supabase = null;

        // Variables Globales
        let currentSection = 'home';
        let currentTheme = 'dark';
        let currentLanguage = 'es'; // Idioma por defecto
        let folders = [];
        let notes = [];
        let files = []; 
        let events = [];
        let currentDate = new Date();
        let currentNoteId = null;
        let checkUpcomingEventsInterval = null;
        const notifiedEventIdsThisSession = new Set();


        // --- Traducciones ---
        const translations = {
            es: {
                "nav.home": "Inicio",
                "nav.folders": "Mis Carpetas",
                "nav.notes": "Bloc de Notas",
                "nav.calendar": "Calendario",
                "nav.files": "Archivos Subidos",
                "nav.settings": "Configuración",
                "header.title": "Mi Espacio Inteligente",
                "home.title": "Bienvenido a tu Espacio Inteligente",
                "home.subtitle": "Donde la inteligencia artificial se encuentra con tu productividad personal",
                "home.cta": "Comenzar Ahora",
                "home.aiTip": "Consejo del Día",
                "home.cards.folders.title": "Gestión de Carpetas",
                "home.cards.folders.desc": "Organiza tus archivos de manera inteligente con carpetas personalizadas y clasificación automática.",
                "home.cards.notes.title": "Notas Inteligentes",
                "home.cards.notes.desc": "Crea, edita y organiza tus ideas con un editor enriquecido y sugerencias de IA.",
                "home.cards.calendar.title": "Calendario Personal",
                "home.cards.calendar.desc": "Planifica tu día con recordatorios inteligentes y gestión avanzada de eventos.",
                "home.cards.ai.title": "Asistente IA",
                "home.cards.ai.desc": "Tu compañero inteligente para responder preguntas y sugerir mejoras en tu flujo de trabajo.",
                "folders.create": "Nueva Carpeta",
                "folders.upload": "Subir Archivo",
                "folders.view": "Vista",
                "folders.dropzone.title": "Arrastra y suelta tus archivos aquí",
                "folders.dropzone.desc": "O haz clic para seleccionar archivos",
                "notes.create": "Nueva Nota",
                "notes.newNoteTitle": "Nueva Nota",
                "notes.untitledNote": "Nota sin Título",
                "notes.pinTooltip": "Fijar/Desfijar Nota",
                "notes.deleteTooltip": "Eliminar Nota",
                "notes.save": "Guardar",
                "notes.delete": "Eliminar",
                "notes.list.title": "Mis Notas",
                "notes.title.placeholder": "Título de la nota...",
                "notes.content.placeholder": "Escribe tu nota aquí...",
                "notes.summarize": "Resumir",
                "notes.continue": "Continuar",
                "calendar.addEvent": "Nuevo Evento",
                "calendar.today": "Hoy",
                "files.search.placeholder": "Buscar archivos...",
                "files.filter.all": "Todos",
                "files.filter.images": "Imágenes",
                "files.filter.documents": "Documentos",
                "files.filter.videos": "Videos",
                "files.filter.audio": "Audio",
                "files.noMatch": "No hay archivos que coincidan.",
                "settings.appearance.title": "Apariencia",
                "settings.appearance.theme": "Modo Oscuro",
                "settings.appearance.font": "Tamaño de Fuente",
                "settings.appearance.font.small": "Pequeño",
                "settings.appearance.font.medium": "Mediano",
                "settings.appearance.font.large": "Grande",
                "settings.language.title": "Idioma",
                "settings.language.select": "Idioma de la Interfaz",
                "settings.language.spanish": "Español",
                "settings.language.english": "English",
                "settings.ai.title": "Configuración de IA",
                "settings.ai.suggestions": "Sugerencias Automáticas",
                "settings.ai.voice": "Reconocimiento de Voz",
                "settings.database.title": "Configuración de Base de Datos",
                "settings.database.status": "Estado de Conexión",
                "settings.database.status.pending": "Pendiente de Configuración",
                "settings.database.status.connected": "Conectado",
                "settings.database.status.error": "Error de Conexión",
                "settings.database.config": "Configurar Conexión",
                "settings.database.config.button": "Configurar",
                "modal.folder.title": "Nueva Carpeta",
                "modal.folder.name": "Nombre de la carpeta:",
                "modal.folder.name.placeholder": "Mi nueva carpeta",
                "modal.folder.create": "Crear Carpeta",
                "modal.event.title": "Nuevo Evento",
                "modal.event.name": "Título del evento:",
                "modal.event.name.placeholder": "Mi evento",
                "modal.event.description": "Descripción:",
                "modal.event.description.placeholder": "Describe tu evento...",
                "modal.event.suggest": "✨ Sugerir Descripción",
                "modal.event.date": "Fecha:",
                "modal.event.time": "Hora:",
                "modal.event.create": "Crear Evento",
                "modal.database.title": "Configuración de Base de Datos",
                "modal.database.desc": "Para conectar tu base de datos Supabase, necesitas añadir tu URL de Supabase y tu Clave Anónima (Anon Key) directamente en las constantes `SUPABASE_URL` y `SUPABASE_ANON_KEY` al inicio del bloque de código JavaScript.",
                "modal.database.connect": "Entendido",
                "modal.tip.title": "✨ Consejo del Día",
                "modal.tip.loading": "Obteniendo consejo...",
                "modal.filePreview.title": "Vista Previa de Archivo",
                "modal.filePreview.download": "Descargar",
                "modal.filePreview.downloadSuggestion": "Puedes intentar descargarlo.",
                "modal.eventNotification.titlePrefix": "🔔 ¡Recordatorio!",
                "modal.eventNotification.title": "🔔 ¡Recordatorio de Evento!",
                "modal.eventNotification.noDescription": "Sin descripción adicional.",
                "modal.eventNotification.close": "Cerrar",
                "notification.error.noDbConnection": "No hay conexión a la base de datos.",
                "notification.error.supabaseConfig": "Supabase URL o Anon Key no configuradas.",
                "notification.error.supabaseConnection": "Error al conectar con Supabase:",
                "notification.error.creating": "Error al crear en",
                "notification.error.reading": "Error al leer de",
                "notification.error.updating": "Error al actualizar en",
                "notification.error.deleting": "Error al eliminar de",
                "notification.error.aiError": "Error de IA:",
                "notification.info.loadingData": "Cargando datos desde Supabase...",
                "notification.success.dataLoaded": "Datos cargados exitosamente.",
                "notification.warning.dataLoadError": "Error al cargar datos. Usando datos de muestra.",
                "notification.success.folderCreated": "Carpeta creada exitosamente.",
                "notification.success.filesProcessed": "archivo(s) procesado(s) y guardado(s).",
                "notification.error.fileUploadError": "Error al subir",
                "notification.error.fileUrlError": "Error al obtener URL pública para",
                "notification.error.fileMetadataError": "Error al guardar metadatos de",
                "notification.warning.noFilesToProcess": "No se pudieron procesar los archivos seleccionados. Revisa la consola para más detalles y verifica tus políticas RLS en Supabase.",
                "notification.success.noteCreated": "Nota creada.",
                "notification.success.noteSaved": "Nota guardada.",
                "notification.success.noteDeleted": "Nota eliminada.",
                "notification.warning.noNoteSelectedSummarize": "Por favor, selecciona una nota para resumir.",
                "notification.warning.emptyNoteSummarize": "La nota está vacía o no ha sido seleccionada correctamente.",
                "notification.success.summaryGenerated": "Resumen generado y guardado como nueva nota.",
                "notification.warning.noNoteSelectedContinue": "Por favor, selecciona una nota para continuar.",
                "notification.warning.noteNotSelectedContinue": "La nota no ha sido seleccionada correctamente.",
                "notification.warning.noNoteSelectedDelete": "No hay ninguna nota seleccionada para eliminar.",
                "notification.success.textContinued": "Texto continuado y añadido a la nota.",
                "notification.warning.emptyEventTitle": "Por favor, ingresa un título para el evento.",
                "notification.success.descriptionSuggested": "Descripción sugerida y añadida.",
                "notification.success.eventCreated": "Evento creado.",
                "notification.warning.eventFormError": "Por favor, completa al menos el título y la fecha del evento.",
                "notification.error.noFileForPreview": "No hay URL o archivo local disponible para previsualizar o descargar.",
                "notification.error.fileTextReadError": "Error al leer el archivo de texto.",
                "notification.info.pdfPreviewNotAvailable": "La previsualización directa de PDF no está disponible. Utiliza el botón de descarga.",
                "notification.info.wordPreviewNotAvailable": "La previsualización directa de archivos Word no está disponible. Utiliza el botón de descarga.",
                "notification.info.genericPreviewNotAvailable": "No hay previsualización directa disponible para este tipo de archivo",
                "notification.info.onlyMetadataPreview": "Este archivo fue cargado en una sesión anterior o es solo metadata. La previsualización completa requiere que el archivo esté almacenado en la nube (ej. Supabase Storage) y que la aplicación esté configurada para accederlo desde allí. Por ahora, la previsualización no está disponible para este archivo.",
                "notification.success.fileDeleted": "Archivo \"${fileName}\" eliminado exitosamente.",
                "notification.warning.fileDeleteFromDBOnly": "Archivo \"${fileName}\" eliminado de la base de datos. Puede que siga en el almacenamiento.",
                "notification.error.fileDeleteErrorDB": "Error al eliminar \"${fileName}\" de la base de datos.",
                "notification.error.fileDeleteErrorStorage": "Error al eliminar del almacenamiento:",
                "notification.error.fileDeletePathError": "No se pudo determinar el path del archivo en Storage desde la URL. Solo se eliminará de la base de datos.",
                "notification.error.fileDeleteException": "Excepción al procesar eliminación de Storage para",
                "db.status.pending": "Base de Datos: Pendiente",
                "db.status.connected": "Base de Datos: Conectado a Supabase",
                "db.status.error": "Base de Datos: Error de conexión",
                "confirm.deleteNote": "¿Estás seguro de eliminar esta nota?",
                "confirm.deleteFile": "¿Estás seguro de eliminar el archivo", 
                "confirm.deleteFileSuffix": "? Esta acción también intentará eliminarlo del almacenamiento.",
                "confirm.cancel": "Cancelar",
                "confirm.ok": "Confirmar",
            },
            en: {
                "nav.home": "Home",
                "nav.folders": "My Folders",
                "nav.notes": "Notepad",
                "nav.calendar": "Calendar",
                "nav.files": "Uploaded Files",
                "nav.settings": "Settings",
                "header.title": "My Smart Space",
                "home.title": "Welcome to your Smart Space",
                "home.subtitle": "Where artificial intelligence meets your personal productivity",
                "home.cta": "Get Started Now",
                "home.aiTip": "Tip of the Day",
                "home.cards.folders.title": "Folder Management",
                "home.cards.folders.desc": "Organize your files intelligently with custom folders and automatic classification.",
                "home.cards.notes.title": "Smart Notes",
                "home.cards.notes.desc": "Create, edit, and organize your ideas with a rich editor and AI suggestions.",
                "home.cards.calendar.title": "Personal Calendar",
                "home.cards.calendar.desc": "Plan your day with smart reminders and advanced event management.",
                "home.cards.ai.title": "AI Assistant",
                "home.cards.ai.desc": "Your smart companion to answer questions and suggest improvements to your workflow.",
                "folders.create": "New Folder",
                "folders.upload": "Upload File",
                "folders.view": "View",
                "folders.dropzone.title": "Drag and drop your files here",
                "folders.dropzone.desc": "Or click to select files",
                "notes.create": "New Note",
                "notes.newNoteTitle": "New Note",
                "notes.untitledNote": "Untitled Note",
                "notes.pinTooltip": "Pin/Unpin Note",
                "notes.deleteTooltip": "Delete Note",
                "notes.save": "Save",
                "notes.delete": "Delete",
                "notes.list.title": "My Notes",
                "notes.title.placeholder": "Note title...",
                "notes.content.placeholder": "Write your note here...",
                "notes.summarize": "Summarize",
                "notes.continue": "Continue",
                "calendar.addEvent": "New Event",
                "calendar.today": "Today",
                "files.search.placeholder": "Search files...",
                "files.filter.all": "All",
                "files.filter.images": "Images",
                "files.filter.documents": "Documents",
                "files.filter.videos": "Videos",
                "files.filter.audio": "Audio",
                "files.noMatch": "No files match.",
                "settings.appearance.title": "Appearance",
                "settings.appearance.theme": "Dark Mode",
                "settings.appearance.font": "Font Size",
                "settings.appearance.font.small": "Small",
                "settings.appearance.font.medium": "Medium",
                "settings.appearance.font.large": "Large",
                "settings.language.title": "Language",
                "settings.language.select": "Interface Language",
                "settings.language.spanish": "Español",
                "settings.language.english": "English",
                "settings.ai.title": "AI Settings",
                "settings.ai.suggestions": "Automatic Suggestions",
                "settings.ai.voice": "Voice Recognition",
                "settings.database.title": "Database Settings",
                "settings.database.status": "Connection Status",
                "settings.database.status.pending": "Pending Configuration",
                "settings.database.status.connected": "Connected",
                "settings.database.status.error": "Connection Error",
                "settings.database.config": "Configure Connection",
                "settings.database.config.button": "Configure",
                "modal.folder.title": "New Folder",
                "modal.folder.name": "Folder name:",
                "modal.folder.name.placeholder": "My new folder",
                "modal.folder.create": "Create Folder",
                "modal.event.title": "New Event",
                "modal.event.name": "Event title:",
                "modal.event.name.placeholder": "My event",
                "modal.event.description": "Description:",
                "modal.event.description.placeholder": "Describe your event...",
                "modal.event.suggest": "✨ Suggest Description",
                "modal.event.date": "Date:",
                "modal.event.time": "Time:",
                "modal.event.create": "Create Event",
                "modal.database.title": "Database Configuration",
                "modal.database.desc": "To connect your Supabase database, you need to add your Supabase URL and Anon Key directly into the `SUPABASE_URL` and `SUPABASE_ANON_KEY` constants at the beginning of the JavaScript code block.",
                "modal.database.connect": "Understood",
                "modal.tip.title": "✨ Tip of the Day",
                "modal.tip.loading": "Fetching tip...",
                "modal.filePreview.title": "File Preview",
                "modal.filePreview.download": "Download",
                "modal.filePreview.downloadSuggestion": "You can try downloading it.",
                "modal.eventNotification.titlePrefix": "🔔 Reminder!",
                "modal.eventNotification.title": "🔔 Event Reminder!",
                "modal.eventNotification.noDescription": "No additional description.",
                "modal.eventNotification.close": "Close",
                "notification.error.noDbConnection": "No database connection.",
                "notification.error.supabaseConfig": "Supabase URL or Anon Key not configured.",
                "notification.error.supabaseConnection": "Error connecting to Supabase:",
                "notification.error.creating": "Error creating in",
                "notification.error.reading": "Error reading from",
                "notification.error.updating": "Error updating in",
                "notification.error.deleting": "Error deleting from",
                "notification.error.aiError": "AI Error:",
                "notification.info.loadingData": "Loading data from Supabase...",
                "notification.success.dataLoaded": "Data loaded successfully.",
                "notification.warning.dataLoadError": "Error loading data. Using sample data.",
                "notification.success.folderCreated": "Folder created successfully.",
                "notification.success.filesProcessed": "file(s) processed and saved.",
                "notification.error.fileUploadError": "Error uploading",
                "notification.error.fileUrlError": "Error getting public URL for",
                "notification.error.fileMetadataError": "Error saving metadata for",
                "notification.warning.noFilesToProcess": "Could not process selected files. Check console for details and verify RLS policies in Supabase.",
                "notification.success.noteCreated": "Note created.",
                "notification.success.noteSaved": "Note saved.",
                "notification.success.noteDeleted": "Note deleted.",
                "notification.warning.noNoteSelectedSummarize": "Please select a note to summarize.",
                "notification.warning.emptyNoteSummarize": "The note is empty or not selected correctly.",
                "notification.success.summaryGenerated": "Summary generated and saved as a new note.",
                "notification.warning.noNoteSelectedContinue": "Please select a note to continue.",
                "notification.warning.noteNotSelectedContinue": "The note is not selected correctly.",
                "notification.warning.noNoteSelectedDelete": "No note selected to delete.",
                "notification.success.textContinued": "Text continued and added to the note.",
                "notification.warning.emptyEventTitle": "Please enter a title for the event.",
                "notification.success.descriptionSuggested": "Description suggested and added.",
                "notification.success.eventCreated": "Event created.",
                "notification.warning.eventFormError": "Please complete at least the event title and date.",
                "notification.error.noFileForPreview": "No URL or local file available for preview or download.",
                "notification.error.fileTextReadError": "Error reading text file.",
                "notification.info.pdfPreviewNotAvailable": "Direct PDF preview is not available. Use the download button.",
                "notification.info.wordPreviewNotAvailable": "Direct Word file preview is not available. Use the download button.",
                "notification.info.genericPreviewNotAvailable": "No direct preview available for this file type",
                "notification.info.onlyMetadataPreview": "This file was uploaded in a previous session or is metadata only. Full preview requires the file to be stored in the cloud (e.g., Supabase Storage) and the app configured to access it. Preview is not available for this file for now.",
                "notification.success.fileDeleted": "File \"${fileName}\" deleted successfully.",
                "notification.warning.fileDeleteFromDBOnly": "File \"${fileName}\" deleted from database. It might still exist in storage.",
                "notification.error.fileDeleteErrorDB": "Error deleting \"${fileName}\" from database.",
                "notification.error.fileDeleteErrorStorage": "Error deleting from storage:",
                "notification.error.fileDeletePathError": "Could not determine file path in Storage from URL. Will only delete from database.",
                "notification.error.fileDeleteException": "Exception while processing Storage deletion for",
                "db.status.pending": "Database: Pending",
                "db.status.connected": "Database: Connected to Supabase",
                "db.status.error": "Database: Connection Error",
                "confirm.deleteNote": "Are you sure you want to delete this note?",
                "confirm.deleteFile": "Are you sure you want to delete the file",
                "confirm.deleteFileSuffix": "? This action will also attempt to delete it from storage.",
                "confirm.cancel": "Cancel",
                "confirm.ok": "Confirm",
            }
        };
        // --- Fin de Traducciones ---


        // --- Gemini API Helper ---
        const GeminiAPIHelper = {
            apiKey: "", 
            apiUrl: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`,

            showLoading: function() {
                console.log("GeminiAPI: Mostrando carga...");
                document.getElementById('loadingOverlay').classList.add('active');
            },

            hideLoading: function() {
                console.log("GeminiAPI: Ocultando carga.");
                document.getElementById('loadingOverlay').classList.remove('active');
            },

            generateText: async function(prompt) {
                console.log("GeminiAPI: generateText llamado con prompt:", prompt);
                this.showLoading();
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                console.log("GeminiAPI: Payload:", JSON.stringify(payload));
                
                try {
                    console.log("GeminiAPI: Realizando fetch a:", `${this.apiUrl}?key=TU_API_KEY_AQUI_SI_PRUEBAS_LOCALMENTE`); 
                    const response = await fetch(`${this.apiUrl}?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    console.log("GeminiAPI: Respuesta recibida, status:", response.status);

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error('GeminiAPI: Error en la respuesta de la API:', response.status, response.statusText, errorBody);
                        throw new Error(`Error de la API de Gemini: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log("GeminiAPI: Resultado JSON:", result);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        this.hideLoading();
                        const generatedText = result.candidates[0].content.parts[0].text;
                        console.log("GeminiAPI: Texto generado:", generatedText);
                        return generatedText;
                    } else {
                        console.error('GeminiAPI: Respuesta inesperada de la API:', result);
                        if (result.promptFeedback && result.promptFeedback.blockReason) {
                            throw new Error(`Contenido bloqueado por la API: ${result.promptFeedback.blockReason}`);
                        }
                        throw new Error('Respuesta inesperada o vacía de la API de Gemini.');
                    }
                } catch (error) {
                    this.hideLoading();
                    console.error('GeminiAPI: Error al llamar a la API:', error);
                    showNotification(getTranslation("notification.error.aiError") + ` ${error.message}`, 'error');
                    return null;
                }
            }
        };
        // --- Fin de Gemini API Helper ---


        const DatabaseManager = {
            isConnected: false,
            config: { 
                tables: {
                    folders: 'folders',
                    notes: 'notes',
                    files: 'files',
                    events: 'events',
                }
            },

            async connect() {
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    const errorMessage = getTranslation("notification.error.supabaseConfig");
                    console.error(errorMessage);
                    updateDbStatus(false, errorMessage);
                    return false;
                }
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Cliente de Supabase inicializado.');
                    this.isConnected = true;
                    updateDbStatus(true, getTranslation("settings.database.status.connected"));
                    return true;
                } catch (error) {
                    console.error('Error al conectar con Supabase:', error);
                    this.isConnected = false;
                    updateDbStatus(false, `${getTranslation("notification.error.supabaseConnection")} ${error.message}`);
                    return false;
                }
            },

            async create(table, dataToInsert) {
                if (!this.isConnected || !supabase) {
                    showNotification(getTranslation("notification.error.noDbConnection"), 'error');
                    return null;
                }
                const { id, ...payload } = dataToInsert;

                if (payload.created && payload.created instanceof Date) {
                    payload.created_at = payload.created.toISOString();
                    delete payload.created;
                } else if (!payload.created_at) {
                     payload.created_at = new Date().toISOString();
                }

                if (payload.updated && payload.updated instanceof Date) {
                    payload.updated_at = payload.updated.toISOString();
                    delete payload.updated;
                } else if (!payload.updated_at && (table === 'notes' || table === 'events')) { 
                    payload.updated_at = payload.created_at;
                }

                 if (payload.uploaded && payload.uploaded instanceof Date) {
                    payload.uploaded_at = payload.uploaded.toISOString();
                    delete payload.uploaded;
                }

                const { data, error } = await supabase.from(this.config.tables[table]).insert([payload]).select();
                if (error) {
                    console.error(`Error creando en ${table}:`, error);
                    showNotification(`${getTranslation("notification.error.creating")} ${table}: ${error.message}`, 'error');
                    return null;
                }
                console.log(`Datos creados en ${table}:`, data);
                return data && data.length > 0 ? data[0] : null;
            },

            async read(table) {
                if (!this.isConnected || !supabase) return [];
                const { data, error } = await supabase.from(this.config.tables[table]).select('*');
                if (error) {
                    console.error(`Error leyendo de ${table}:`, error);
                    showNotification(`${getTranslation("notification.error.reading")} ${table}: ${error.message}`, 'error');
                    return [];
                }
                return data || [];
            },

            async update(table, id, dataToUpdate) {
                if (!this.isConnected || !supabase) {
                     showNotification(getTranslation("notification.error.noDbConnection"), 'error');
                     return null;
                }
                const { id: recordId, ...updatePayload } = dataToUpdate;

                if (updatePayload.updated && updatePayload.updated instanceof Date) {
                    updatePayload.updated_at = updatePayload.updated.toISOString();
                    delete updatePayload.updated;
                } else if (!updatePayload.updated_at) {
                    updatePayload.updated_at = new Date().toISOString();
                }
                if (updatePayload.created_at) delete updatePayload.created_at;
                if (updatePayload.created) delete updatePayload.created;

                const { data, error } = await supabase
                    .from(this.config.tables[table])
                    .update(updatePayload)
                    .eq('id', id)
                    .select();
                if (error) {
                    console.error(`Error actualizando ID ${id} en ${table}:`, error);
                    showNotification(`${getTranslation("notification.error.updating")} ${table}: ${error.message}`, 'error');
                    return null;
                }
                console.log(`Datos actualizados en ${table} (ID: ${id}):`, data);
                return data && data.length > 0 ? data[0] : null;
            },

            async delete(table, id) {
                if (!this.isConnected || !supabase) {
                    showNotification(getTranslation("notification.error.noDbConnection"), 'error');
                    return false;
                }
                const { error } = await supabase.from(this.config.tables[table]).delete().eq('id', id);
                if (error) {
                    console.error(`Error eliminando ID ${id} de ${table}:`, error);
                    showNotification(`${getTranslation("notification.error.deleting")} ${table}: ${error.message}`, 'error');
                    return false;
                }
                console.log(`ID ${id} eliminado de ${table}`);
                return true;
            }
        };
        function updateDbStatus(connected, message) {
            const dbStatusDiv = document.getElementById('dbStatus');
            const dbConnectionStatusSpan = document.getElementById('dbConnectionStatus');
            const dbStatusText = dbStatusDiv.querySelector('span');


            if (connected) {
                dbStatusDiv.classList.add('connected');
                dbStatusText.textContent = getTranslation("db.status.connected");
                if (dbConnectionStatusSpan) {
                    dbConnectionStatusSpan.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success-color);"></i> ${getTranslation("settings.database.status.connected")}`;
                    dbConnectionStatusSpan.style.color = 'var(--success-color)';
                }
            } else {
                dbStatusDiv.classList.remove('connected');
                const statusKey = message.includes("configuradas") ? "db.status.pending" : "db.status.error";
                dbStatusText.textContent = message || getTranslation(statusKey);

                if (dbConnectionStatusSpan) {
                    dbConnectionStatusSpan.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i> ${message || getTranslation(statusKey)}`;
                    dbConnectionStatusSpan.style.color = 'var(--warning-color)';
                }
            }
        }


        async function initializeApp() {
            currentLanguage = localStorage.getItem('language') || 'es'; 
            setLanguage(currentLanguage); 

            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            
            const connected = await DatabaseManager.connect();
            if (connected) {
                await loadDataFromSupabase();
            } else {
                showNotification(getTranslation("notification.warning.dataLoadError"), 'warning');
                loadSampleData();
                renderAllSections();
            }

            updateDateTime();
            setupEventListeners();
            showSection(localStorage.getItem('lastSection') || 'home');
            startEventNotificationChecks();
        }

        async function loadDataFromSupabase() {
            showNotification(getTranslation("notification.info.loadingData"), 'info');
            try {
                folders = (await DatabaseManager.read('folders')).map(f => ({...f, id: f.id, name: f.name, created: new Date(f.created_at)})) || [];
                
                const notesData = await DatabaseManager.read('notes') || [];
                notes = notesData.map(n => ({
                    ...n,
                    id: n.id,
                    created: new Date(n.created_at),
                    updated: new Date(n.updated_at)
                })).sort((a,b) => new Date(b.updated) - new Date(a.updated))
                   .sort((a,b) => (b.pinned ? 1 : 0) - (a.pinned ? 1: 0));

                if (notes.length > 0 && !currentNoteId) {
                     currentNoteId = notes[0].id;
                }

                const filesData = await DatabaseManager.read('files') || [];
                files = filesData.map(f => ({
                    id: f.id, 
                    file_name: f.file_name, 
                    size: f.size,
                    type: f.type,
                    url: f.url, 
                    uploaded: new Date(f.uploaded_at || f.created_at), 
                })) || [];


                const eventsData = await DatabaseManager.read('events') || [];
                events = eventsData.map(e => {
                    const eventDateString = e.date && typeof e.date === 'string' ? e.date.split('T')[0] : new Date().toISOString().split('T')[0];
                    if (!(e.date && typeof e.date === 'string')) {
                        console.warn(`Evento con ID ${e.id} tiene fecha faltante o inválida ('${e.date}'). Usando fecha actual por defecto.`);
                    }
                    return {...e, id: e.id, created: new Date(e.created_at), date: eventDateString, description: e.description || '' };
                }) || [];

                console.log('Datos cargados desde Supabase.');
                showNotification(getTranslation("notification.success.dataLoaded"), 'success');
            } catch (error) {
                console.error('Error al cargar datos desde Supabase:', error);
                showNotification(getTranslation("notification.warning.dataLoadError"), 'warning');
                loadSampleData();
            }
            renderAllSections();
        }

        function renderAllSections() {
            renderFolders();
            renderNotes();
            if (currentNoteId) selectNote(currentNoteId); else if (notes.length > 0) { currentNoteId = notes[0].id; selectNote(currentNoteId); }
            generateCalendar();
            renderFiles();
        }


        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function setupEventListeners() {
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('langToggle').addEventListener('click', toggleLanguage);

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    showSection(section);
                });
            });

            document.getElementById('darkModeToggle').addEventListener('click', function() {
                // setTheme se encarga de la lógica y de actualizar la clase 'active' de este toggle
            });
            document.getElementById('fontSizeSelect').addEventListener('change', changeFontSize);
            document.getElementById('languageSelect').addEventListener('change', changeLanguage);

            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            const dropZone = document.getElementById('dropZone');
            if (dropZone) { 
                dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);
            }


            document.getElementById('fileSearch').addEventListener('input', searchFiles);
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.getAttribute('data-filter');
                    filterFiles(filter);
                });
            });

            document.getElementById('noteContent').addEventListener('input', autoSaveNote);
            document.getElementById('noteTitle').addEventListener('input', autoSaveNote);

            document.getElementById('summarizeNoteBtn').addEventListener('click', summarizeNoteWithGemini);
            document.getElementById('continueWritingBtn').addEventListener('click', continueWritingWithGemini);
            // Botón de sugerir descripción de evento ELIMINADO
            document.getElementById('dailyTipBtn').addEventListener('click', showDailyTip); 
        }

        async function summarizeNoteWithGemini() {
            console.log("Intentando resumir nota...");
            if (!currentNoteId) {
                showNotification(getTranslation("notification.warning.noNoteSelectedSummarize"), 'warning');
                console.log("Resumir: No hay nota seleccionada.");
                return;
            }
            const note = notes.find(n => n.id === currentNoteId);
            if (!note || !note.content || !note.content.trim()) {
                showNotification(getTranslation("notification.warning.emptyNoteSummarize"), 'warning');
                console.log("Resumir: Nota vacía o no encontrada. Nota:", note);
                return;
            }
            console.log("Resumir: Nota a resumir:", note.title, "Contenido:", note.content.substring(0,100) + "...");

            const prompt = `Resume el siguiente texto en español de forma concisa y clara, manteniendo las ideas principales:\n\n"${note.content}"\n\nResumen:`;
            console.log("Resumir: Prompt para Gemini:", prompt);
            const summary = await GeminiAPIHelper.generateText(prompt);
            console.log("Resumir: Respuesta de Gemini (resumen):", summary);


            if (summary) {
                const summaryTitle = `Resumen de: ${note.title}`;
                const newNoteData = {
                    title: summaryTitle,
                    content: summary,
                    pinned: false,
                };
                console.log("Resumir: Creando nueva nota con resumen:", newNoteData);
                const createdSummaryNote = await DatabaseManager.create('notes', newNoteData);
                if (createdSummaryNote) {
                    console.log("Resumir: Nota de resumen creada en DB:", createdSummaryNote);
                    const fullSummaryNote = {...createdSummaryNote, id: createdSummaryNote.id, created: new Date(createdSummaryNote.created_at), updated: new Date(createdSummaryNote.updated_at) };
                    notes.unshift(fullSummaryNote); 
                    currentNoteId = fullSummaryNote.id; 
                    renderNotes();
                    selectNote(fullSummaryNote.id);
                    showNotification(getTranslation("notification.success.summaryGenerated"), 'success');
                } else {
                    console.error("Resumir: Falló la creación de la nota de resumen en la DB.");
                }
            } else {
                 console.log("Resumir: Gemini no devolvió un resumen.");
            }
        }

        async function continueWritingWithGemini() {
            console.log("Intentando continuar escritura...");
            if (!currentNoteId) {
                showNotification(getTranslation("notification.warning.noNoteSelectedContinue"), 'warning');
                 console.log("Continuar: No hay nota seleccionada.");
                return;
            }
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) {
                showNotification(getTranslation("notification.warning.noteNotSelectedContinue"), 'warning');
                console.log("Continuar: Nota no encontrada.");
                return;
            }
            const currentContent = document.getElementById('noteContent').value; 
            console.log("Continuar: Contenido actual para continuar:", currentContent.substring(0,100) + "...");


            const prompt = `Continúa escribiendo el siguiente texto en español de forma natural y coherente, añadiendo uno o dos párrafos que fluyan bien con el contenido existente. Evita repetir frases introductorias como "Continuación:". Simplemente añade el nuevo texto.\n\nTexto existente:\n"${currentContent}"\n\nTexto adicional:`;
            console.log("Continuar: Prompt para Gemini:", prompt);
            const continuation = await GeminiAPIHelper.generateText(prompt);
            console.log("Continuar: Respuesta de Gemini (continuación):", continuation);

            if (continuation) {
                document.getElementById('noteContent').value += `\n\n${continuation.trim()}`;
                console.log("Continuar: Contenido actualizado en textarea.");
                await saveNote(false); 
                showNotification(getTranslation("notification.success.textContinued"), 'success');
            } else {
                console.log("Continuar: Gemini no devolvió una continuación.");
            }
        }
        
        const dailyPhrases = [
            "La sonrisa es el idioma universal de las almas inteligentes.",
            "El único modo de hacer un gran trabajo es amar lo que haces. - Steve Jobs",
            "La vida es como una bicicleta, para mantener el equilibrio debes seguir adelante. - Albert Einstein",
            "Cree en ti mismo y todo será posible.",
            "El éxito es la suma de pequeños esfuerzos repetidos día tras día. - Robert Collier",
            "No cuentes los días, haz que los días cuenten. - Muhammad Ali",
            "La mejor manera de predecir el futuro es crearlo. - Peter Drucker",
            "El optimismo es la fe que conduce al logro; nada puede realizarse sin esperanza. - Helen Keller",
            "Cada día es una nueva oportunidad para cambiar tu vida.",
            "La felicidad no es algo hecho. Proviene de tus propias acciones. - Dalai Lama"
        ];

        function showDailyTip() { 
            console.log("Mostrando consejo del día (local)...");
            const tipModalContent = document.getElementById('tipModalContent');
            
            const randomIndex = Math.floor(Math.random() * dailyPhrases.length);
            const tip = dailyPhrases[randomIndex];
            
            tipModalContent.textContent = tip;
            openModal('tipModal');
            console.log("Consejo del Día (local):", tip);
        }


        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(sectionName);
            if (activeSection) activeSection.classList.add('active');


            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeLink) activeLink.classList.add('active');

            currentSection = sectionName;
            localStorage.setItem('lastSection', sectionName); 

            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('show') && window.innerWidth <= 768) { 
                toggleSidebar(); 
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('show');
            mainContent.classList.toggle('expanded', !sidebar.classList.contains('show')); 
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(currentTheme);
        }

        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            currentTheme = theme;
            const themeIcon = document.querySelector('#themeToggle i');
            const darkModeSwitch = document.getElementById('darkModeToggle');

            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun';
                if (darkModeSwitch) darkModeSwitch.classList.add('active');
            } else {
                themeIcon.className = 'fas fa-moon';
                if (darkModeSwitch) darkModeSwitch.classList.remove('active');
            }
            localStorage.setItem('theme', theme);
        }
        
        function getTranslation(key, lang = currentLanguage) {
            return translations[lang]?.[key] || key; 
        }

        function applyTranslations(lang) {
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                const translation = getTranslation(key, lang);
                
                if (el.hasAttribute('data-translate-placeholder')) {
                    el.placeholder = translation;
                } else if (el.hasAttribute('data-translate-title')) {
                     el.title = translation;
                } else {
                    let textNode = Array.from(el.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '');
                    if (textNode) {
                        textNode.textContent = translation;
                    } else if (el.childNodes.length === 0 || (el.childNodes.length === 1 && el.childNodes[0].nodeType === Node.TEXT_NODE)) {
                        el.textContent = translation;
                    } else {
                        const spanToTranslate = el.querySelector('span[data-translate-target="true"]');
                        if (spanToTranslate) {
                            spanToTranslate.textContent = translation;
                        } else if (el.id === 'langToggleText') {
                            el.textContent = lang.toUpperCase(); // Special case for lang toggle text
                        } else {
                             console.warn(`Elemento con key '${key}' tiene hijos complejos y no se encontró target específico para traducción.`)
                        }
                    }
                }
            });
            document.title = getTranslation("header.title", lang); 
        }


        function setLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang; 
            
            const langToggleText = document.getElementById('langToggleText');
            if (langToggleText) {
                langToggleText.textContent = lang.toUpperCase();
            } else { 
                 const langToggleBtn = document.getElementById('langToggle');
                 if(langToggleBtn) langToggleBtn.innerHTML = `<i class="fas fa-globe"></i> <span id="langToggleText">${lang.toUpperCase()}</span>`;
            }

            document.getElementById('languageSelect').value = lang;
            localStorage.setItem('language', lang);
            applyTranslations(lang);
            generateCalendar(); // Regenerar calendario con nombres de días/meses en el nuevo idioma
        }


        function changeLanguage(e) {
            setLanguage(e.target.value);
        }
        function toggleLanguage() {
            const newLang = currentLanguage === 'es' ? 'en' : 'es';
            setLanguage(newLang);
        }


        function changeFontSize(e) {
            const size = e.target.value;
            document.body.style.fontSize = size === 'small' ? '14px' : size === 'large' ? '18px' : '16px';
            localStorage.setItem('fontSize', size);
        }
        document.addEventListener('DOMContentLoaded', () => {
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                document.body.style.fontSize = savedFontSize === 'small' ? '14px' : savedFontSize === 'large' ? '18px' : '16px';
                document.getElementById('fontSizeSelect').value = savedFontSize;
            }
        });


        async function createFolder() {
            document.getElementById('folderModal').classList.add('active');
        }

        async function confirmCreateFolder() {
            const name = document.getElementById('folderNameInput').value.trim();
            if (name) {
                const newFolderData = { name: name }; 
                const createdFolder = await DatabaseManager.create('folders', newFolderData);
                if (createdFolder) {
                    folders.push({...createdFolder, id: createdFolder.id, name: createdFolder.name, created: new Date(createdFolder.created_at)});
                    renderFolders();
                    closeModal('folderModal');
                    document.getElementById('folderNameInput').value = '';
                    showNotification(getTranslation("notification.success.folderCreated"), 'success');
                }
            }
        }

        function renderFolders() {
            const grid = document.getElementById('foldersGrid');
            if (!grid) return;
            grid.innerHTML = '';
            folders.sort((a,b) => new Date(b.created) - new Date(a.created)); 

            folders.forEach(folder => {
                const folderElement = document.createElement('div');
                folderElement.className = 'folder-item';
                folderElement.innerHTML = `
                    <div class="folder-icon"><i class="fas fa-folder"></i></div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-stats">0 archivos</div>
                `;
                folderElement.addEventListener('click', () => openFolder(folder.id));
                grid.appendChild(folderElement);
            });
        }

        function openFolder(folderId) {
            const folder = folders.find(f => f.id === folderId);
            if (folder) {
                showNotification(`Abriendo carpeta (simulado): ${folder.name}`, 'info');
            }
        }

        function uploadFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(e) {
            const selectedFiles = Array.from(e.target.files);
            if (selectedFiles.length > 0) {
                processFiles(selectedFiles);
            }
            e.target.value = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            const dropZone = document.getElementById('dropZone');
            if (dropZone) dropZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            const dropZone = document.getElementById('dropZone');
            if (dropZone) dropZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropZone = document.getElementById('dropZone');
            if (dropZone) dropZone.classList.remove('dragover');
            const droppedFiles = Array.from(e.dataTransfer.files);
            if (droppedFiles.length > 0) {
                processFiles(droppedFiles);
            }
        }

        async function processFiles(fileList) {
            if (!DatabaseManager.isConnected || !supabase) {
                showNotification(getTranslation("notification.error.noDbConnection"), 'error');
                showNotification(getTranslation("notification.error.rlsWarning"), "warning", 7000);
                return;
            }

            let filesProcessedCount = 0;
            let previewedFile = false; 

            for (const file of fileList) {
                showNotification(`Subiendo ${file.name}...`, 'info');
                const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9._-\s]/g, '').replace(/\s+/g, '_');
                const filePath = `public/${Date.now()}-${sanitizedFileName}`; 

                try {
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('archivos') 
                        .upload(filePath, file, {
                            cacheControl: '3600', 
                            upsert: false 
                        });

                    if (uploadError) {
                        console.error('Error subiendo archivo a Supabase Storage:', uploadError);
                        if (uploadError.message && uploadError.message.includes('violates row-level security policy')) {
                             showNotification(`${getTranslation("notification.error.fileUploadError")} ${file.name}: ${uploadError.message}. ${getTranslation("notification.error.rlsWarning")}`, 'error', 10000); 
                        } else {
                            showNotification(`${getTranslation("notification.error.fileUploadError")} ${file.name}: ${uploadError.message}`, 'error');
                        }
                        continue; 
                    }

                    const { data: urlData } = supabase.storage
                        .from('archivos')
                        .getPublicUrl(uploadData.path);

                    if (!urlData || !urlData.publicUrl) {
                        console.error('Error obteniendo URL pública para:', uploadData.path, urlData);
                        showNotification(`${getTranslation("notification.error.fileUrlError")} ${file.name}. ${getTranslation("notification.error.bucketPolicyWarning")}`, 'error', 7000);
                        continue;
                    }
                    const publicUrl = urlData.publicUrl;
                    console.log(`Archivo '${file.name}' subido a Supabase. URL pública: ${publicUrl}`);

                    const fileMetadata = {
                        file_name: file.name, 
                        size: file.size,
                        type: file.type,
                        url: publicUrl,
                    };

                    const createdFileInDB = await DatabaseManager.create('files', fileMetadata);

                    if (createdFileInDB) {
                        const fullFileObject = {
                            ...createdFileInDB, 
                            uploaded: new Date(createdFileInDB.uploaded_at || createdFileInDB.created_at), 
                        };
                        files.unshift(fullFileObject); 
                        filesProcessedCount++;

                        if (!previewedFile) { 
                            openFilePreviewModal(fullFileObject);
                            previewedFile = true;
                        }
                    } else {
                        showNotification(`${getTranslation("notification.error.fileMetadataError")} ${file.name}.`, 'error');
                    }

                } catch (storageError) {
                    console.error('Excepción durante la operación con Supabase Storage:', storageError);
                    showNotification(`Error con Storage para ${file.name}: ${storageError.message}`, 'error');
                    continue; 
                }
            }

            renderFiles(); 
            if (filesProcessedCount > 0) {
                showNotification(`${filesProcessedCount} ${getTranslation("notification.success.filesProcessed")}`, 'success');
            } else if (fileList.length > 0) {
                showNotification(getTranslation("notification.warning.noFilesToProcess"), 'warning', 7000);
            }
        }


        function renderFiles() {
            const grid = document.getElementById('filesGrid');
            if(!grid) return;
            grid.innerHTML = '';

            const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active')?.getAttribute('data-filter') || 'all';

            const filteredFiles = files.filter(file => {
                const nameMatch = file.file_name ? file.file_name.toLowerCase().includes(searchTerm) : false;
                if (!nameMatch) return false;

                if (activeFilter === 'all') return true;
                if (activeFilter === 'image') return file.type && file.type.startsWith('image/');
                if (activeFilter === 'document') return file.type && (file.type.includes('pdf') || file.type.includes('word') || file.type.includes('document') || file.type.includes('excel') || file.type.includes('spreadsheet') || file.type.includes('text'));
                if (activeFilter === 'video') return file.type && file.type.startsWith('video/');
                if (activeFilter === 'audio') return file.type && file.type.startsWith('audio/');
                return false;
            }).sort((a,b) => new Date(b.uploaded) - new Date(a.uploaded)); 


            if (filteredFiles.length === 0) {
                grid.innerHTML = `<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">${getTranslation("files.noMatch") || "No hay archivos que coincidan."}</p>`;
                return;
            }

            filteredFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-item';
                const icon = getFileIcon(file.type);
                const size = formatFileSize(file.size);
                fileElement.innerHTML = `
                    <div class="file-icon" style="color: ${getFileColor(file.type)}"><i class="${icon}"></i></div>
                    <div class="file-name" title="${file.file_name}">${file.file_name}</div>
                    <div class.file-size">${size}</div>
                    <i class="fas fa-trash delete-file-icon" title="Eliminar archivo"></i>`;
                fileElement.querySelector('.delete-file-icon').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    deleteFileConfirmation(file.id, file.file_name, file.url);
                });
                fileElement.addEventListener('click', () => openFilePreviewModal(file)); 
                grid.appendChild(fileElement);
            });
        }

        function getFileIcon(type) {
            if (!type) return 'fas fa-file';
            if (type.startsWith('image/')) return 'fas fa-file-image';
            if (type.startsWith('video/')) return 'fas fa-file-video';
            if (type.startsWith('audio/')) return 'fas fa-file-audio';
            if (type.includes('pdf')) return 'fas fa-file-pdf'; 
            if (type.includes('word') || type.includes('document')) return 'fas fa-file-word';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'fas fa-file-excel';
            if (type.includes('presentation') || type.includes('powerpoint')) return 'fas fa-file-powerpoint';
            if (type.includes('zip') || type.includes('archive')) return 'fas fa-file-archive';
            return 'fas fa-file';
        }

        function getFileColor(type) {
            if (!type) return '#6c5ce7'; 
            if (type.startsWith('image/')) return '#ff6b6b'; 
            if (type.startsWith('video/')) return '#4ecdc4'; 
            if (type.startsWith('audio/')) return '#45b7d1'; 
            if (type.includes('pdf')) return '#ff4757'; 
            if (type.includes('word')) return '#2e86de'; 
            if (type.includes('excel')) return '#1dd1a1'; 
            if (type.includes('presentation')) return '#f39c12'; 
            return '#6c5ce7'; 
        }


        function formatFileSize(bytes) {
            if (bytes === 0 || !bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function searchFiles() { renderFiles(); }
        function filterFiles(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn[data-filter="${filter}"]`).classList.add('active');
            renderFiles();
        }

        async function deleteFileConfirmation(fileId, fileName, fileUrl) {
            const confirmMessage = `${getTranslation("confirm.deleteFile")} "${fileName}"${getTranslation("confirm.deleteFileSuffix")}`;
            showCustomConfirm(confirmMessage, async () => {
                console.log(`Intentando eliminar archivo: ID=${fileId}, Nombre=${fileName}, URL=${fileUrl}`);
                let deletedFromStorage = false;

                if (fileUrl && typeof fileUrl === 'string' && supabase) {
                    try {
                        const urlObj = new URL(fileUrl);
                        const pathPrefix = `/storage/v1/object/public/archivos/`; 
                        let storagePath = urlObj.pathname.substring(urlObj.pathname.indexOf(pathPrefix) + pathPrefix.length);
                        
                        storagePath = decodeURIComponent(storagePath);

                        if (storagePath) {
                            console.log(`Intentando eliminar de Supabase Storage, bucket 'archivos', path: '${storagePath}'`);
                            const { error: storageError } = await supabase.storage.from('archivos').remove([storagePath]);
                            if (storageError) {
                                console.error('Error eliminando archivo de Supabase Storage:', storageError);
                                showNotification(`${getTranslation("notification.error.fileDeleteErrorStorage")} '${fileName}': ${storageError.message}`, 'error');
                            } else {
                                console.log(`Archivo '${fileName}' eliminado de Supabase Storage exitosamente.`);
                                deletedFromStorage = true;
                            }
                        } else {
                             console.warn(`No se pudo determinar el path del archivo en Storage desde la URL: ${fileUrl}`);
                        }
                    } catch (e) {
                         console.error("Error al parsear la URL del archivo o al interactuar con Storage:", e);
                         showNotification(`${getTranslation("notification.error.fileDeleteException")} '${fileName}': ${e.message}`, 'error');
                    }
                }

                const dbSuccess = await DatabaseManager.delete('files', fileId);
                if (dbSuccess) {
                    files = files.filter(f => f.id !== fileId);
                    renderFiles();
                    if (deletedFromStorage || !fileUrl) { 
                        showNotification(getTranslation("notification.success.fileDeleted").replace('${fileName}', fileName), 'success');
                    } else { 
                         showNotification(getTranslation("notification.warning.fileDeleteFromDBOnly").replace('${fileName}', fileName), 'warning');
                    }
                } else {
                     if (!fileUrl || (fileUrl && deletedFromStorage)) { 
                        showNotification(getTranslation("notification.error.fileDeleteErrorDB").replace('${fileName}', fileName), 'error');
                     }
                }
            });
        }

        function cleanUrl(url) {
            if (typeof url !== 'string') return url;
            // Primero, asegurar que el protocolo (http o https) tenga solo dos slashes.
            let cleaned = url.replace(/^(https?|ftp):[\/]{2,}/i, '$1://');
            // Luego, reemplazar cualquier secuencia de múltiples slashes (//, ///, etc.) en el resto de la URL
            // con un solo slash. Esto se hace con una expresión regular que busca slashes
            // que NO estén precedidos por dos puntos (para no afectar el :// del protocolo).
            cleaned = cleaned.replace(/([^:])\/\/+/g, '$1/');
            return cleaned;
        }

        function openFilePreviewModal(fileObject) {
            const modal = document.getElementById('filePreviewModal');
            const titleElement = document.getElementById('filePreviewTitle');
            const imgElement = document.getElementById('filePreviewImage');
            const videoElement = document.getElementById('filePreviewVideo');
            const audioElement = document.getElementById('filePreviewAudio');
            const iframeElement = document.getElementById('filePreviewIframe'); 
            const textElement = document.getElementById('filePreviewText');
            const fallbackElement = document.getElementById('filePreviewFallback');
            const downloadLink = document.getElementById('fileDownloadLink');

            [imgElement, videoElement, audioElement, iframeElement, textElement, fallbackElement].forEach(el => {
                el.style.display = 'none';
                if (el.tagName === 'IMG' || el.tagName === 'VIDEO' || el.tagName === 'AUDIO' || el.tagName === 'IFRAME') {
                    el.removeAttribute('src'); 
                }
                if (el.tagName === 'PRE') {
                    el.textContent = '';
                }
            });

            titleElement.textContent = fileObject.file_name || getTranslation("modal.filePreview.title");
            let previewSrc = null;
            let canDownload = false;

            if (fileObject.url && typeof fileObject.url === 'string') {
                previewSrc = cleanUrl(fileObject.url); // Limpiar la URL
                downloadLink.href = previewSrc;
                downloadLink.download = fileObject.file_name || 'archivo';
                downloadLink.style.display = 'inline-block';
                canDownload = true;
                console.log("File Preview: Using Supabase URL (cleaned):", previewSrc);
            } else if (fileObject.file && fileObject.file instanceof File) { 
                previewSrc = URL.createObjectURL(fileObject.file);
                downloadLink.href = previewSrc;
                downloadLink.download = fileObject.file_name || 'archivo';
                downloadLink.style.display = 'inline-block';
                canDownload = true;
                console.log("File Preview: Using local Object URL.");
            } else {
                fallbackElement.textContent = getTranslation("notification.error.noFileForPreview");
                fallbackElement.style.display = 'block';
                downloadLink.style.display = 'none';
                openModal('filePreviewModal');
                return;
            }

            const fileType = fileObject.type || '';
            console.log(`File Preview: Attempting to preview ${fileObject.file_name}, Type: ${fileType}, Source: ${previewSrc}`);

            let previewed = false;
            if (previewSrc) {
                if (fileType.startsWith('image/')) {
                    imgElement.src = previewSrc;
                    imgElement.style.display = 'block';
                    previewed = true;
                } else if (fileType.startsWith('video/')) {
                    videoElement.src = previewSrc;
                    videoElement.style.display = 'block';
                    videoElement.load();
                    previewed = true;
                } else if (fileType.startsWith('audio/')) {
                    audioElement.src = previewSrc;
                    audioElement.style.display = 'block';
                    audioElement.load();
                    previewed = true;
                } else if (fileType.includes('pdf')) { 
                    // Usar PDF.js viewer
                    const pdfjsViewerUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(previewSrc)}`;
                    console.log("File Preview: PDF detected. Setting iframe source to PDF.js viewer:", pdfjsViewerUrl);
                    iframeElement.src = pdfjsViewerUrl;
                    iframeElement.style.display = 'block';
                    previewed = true;
                } else if (fileType.startsWith('text/') && fileObject.file && !fileObject.url) { 
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        textElement.textContent = e.target.result;
                        textElement.style.display = 'block';
                    }
                    reader.onerror = function() {
                        fallbackElement.textContent = getTranslation("notification.error.fileTextReadError");
                        fallbackElement.style.display = 'block';
                    }
                    reader.readAsText(fileObject.file);
                    previewed = true; 
                }
            }

            if (!previewed) { 
                 if (fileObject.url || (fileObject.file && fileObject.file instanceof File)) { 
                    fallbackElement.textContent = `${getTranslation("notification.info.genericPreviewNotAvailable")} (${fileType || 'desconocido'}). ${getTranslation("modal.filePreview.downloadSuggestion") || "Puedes intentar descargarlo."}`;
                } else { 
                    fallbackElement.textContent = getTranslation("notification.error.noFileForPreview");
                }
                fallbackElement.style.display = 'block';
            }
            
            if (!canDownload) { 
                downloadLink.style.display = 'none';
            }

            openModal('filePreviewModal');
        }


        // --- Gestión de Carpetas (Placeholder) ---
        async function createFolder() {
            document.getElementById('folderModal').classList.add('active');
        }
        async function confirmCreateFolder() {
            const name = document.getElementById('folderNameInput').value.trim();
            if (name) {
                const newFolderData = { name: name };
                const createdFolder = await DatabaseManager.create('folders', newFolderData);
                if (createdFolder) {
                    folders.push({...createdFolder, id: createdFolder.id, name: createdFolder.name, created: new Date(createdFolder.created_at)});
                    renderFolders();
                    closeModal('folderModal');
                    document.getElementById('folderNameInput').value = '';
                    showNotification(getTranslation("notification.success.folderCreated"), 'success');
                }
            }
        }
        function renderFolders() {
            const grid = document.getElementById('foldersGrid');
            if (!grid) return;
            grid.innerHTML = '';
            folders.sort((a,b) => new Date(b.created) - new Date(a.created));
            folders.forEach(folder => {
                const folderElement = document.createElement('div');
                folderElement.className = 'folder-item';
                folderElement.innerHTML = `
                    <div class="folder-icon"><i class="fas fa-folder"></i></div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-stats">0 archivos</div> `;
                folderElement.addEventListener('click', () => openFolder(folder.id));
                grid.appendChild(folderElement);
            });
        }
        function openFolder(folderId) {
            const folder = folders.find(f => f.id === folderId);
            if (folder) {
                showNotification(`Abriendo carpeta (simulado): ${folder.name}`, 'info');
            }
        }

        // --- Gestión de Notas ---
        async function createNote() {
            const newNoteData = { title: getTranslation("notes.newNoteTitle") || 'Nueva Nota', content: '', pinned: false };
            const createdNote = await DatabaseManager.create('notes', newNoteData);
            if (createdNote) {
                const fullNote = {...createdNote, id: createdNote.id, created: new Date(createdNote.created_at), updated: new Date(createdNote.updated_at) };
                notes.unshift(fullNote);
                currentNoteId = fullNote.id;
                renderNotes();
                selectNote(fullNote.id);
                showNotification(getTranslation("notification.success.noteCreated"), 'success');
            }
        }
        function renderNotes() {
            const notesListContainer = document.getElementById('notesList');
            if(!notesListContainer) return;
            notesListContainer.innerHTML = '';
            notes.sort((a,b) => new Date(b.updated) - new Date(a.updated))
                 .sort((a,b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));

            notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = `note-item ${currentNoteId === note.id ? 'active' : ''}`;
                noteElement.setAttribute('data-note-id', note.id);
                noteElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong title="${note.title}">${note.title ? note.title.substring(0,30) : getTranslation("notes.untitledNote")}${note.title && note.title.length > 30 ? '...' : ''}</strong>
                        <div>
                          <i class="fas fa-thumbtack pin-note" style="color: ${note.pinned ? 'var(--accent-color)' : 'var(--text-secondary)'}; cursor:pointer; margin-right: 8px;" title="${getTranslation("notes.pinTooltip") || "Fijar/Desfijar Nota"}"></i>
                          <i class="fas fa-trash delete-note-icon" style="color: var(--text-secondary); cursor:pointer;" title="${getTranslation("notes.deleteTooltip") || "Eliminar Nota"}"></i>
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        ${note.content ? note.content.substring(0, 50) : ''}${note.content && note.content.length > 50 ? '...' : ''}
                    </div>`;
                noteElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('pin-note')) {
                        e.stopPropagation(); togglePinNote(note.id);
                    } else if (e.target.classList.contains('delete-note-icon')) {
                        e.stopPropagation(); deleteNoteConfirmation(note.id);
                    } else {
                        selectNote(note.id);
                    }
                });
                notesListContainer.appendChild(noteElement);
            });
             if (!currentNoteId && notes.length > 0) {
                currentNoteId = notes[0].id;
            }
            if (currentNoteId) {
                selectNote(currentNoteId);
            } else {
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
            }
        }
        async function togglePinNote(noteId) {
            const noteIndex = notes.findIndex(n => n.id === noteId);
            if (noteIndex > -1) {
                const originalPinnedState = notes[noteIndex].pinned;
                notes[noteIndex].pinned = !notes[noteIndex].pinned;
                notes[noteIndex].updated = new Date(); 
                
                const updatedNoteDB = await DatabaseManager.update('notes', noteId, { pinned: notes[noteIndex].pinned });
                if (updatedNoteDB) {
                     notes[noteIndex] = {...notes[noteIndex], ...updatedNoteDB, updated: new Date(updatedNoteDB.updated_at), created: new Date(updatedNoteDB.created_at) };
                    renderNotes(); 
                } else { 
                    notes[noteIndex].pinned = originalPinnedState;
                    notes[noteIndex].updated = new Date(notes[noteIndex].updated_at); 
                }
            }
        }
        function deleteNoteConfirmation(noteId) {
            showCustomConfirm(getTranslation("confirm.deleteNote"), async () => {
                const success = await DatabaseManager.delete('notes', noteId);
                if (success) {
                    notes = notes.filter(n => n.id !== noteId);
                    if (currentNoteId === noteId) {
                        currentNoteId = notes.length > 0 ? notes[0].id : null;
                         if (currentNoteId) selectNote(currentNoteId);
                         else {
                            document.getElementById('noteTitle').value = '';
                            document.getElementById('noteContent').value = '';
                        }
                    }
                    renderNotes();
                    showNotification(getTranslation("notification.success.noteDeleted"), 'success');
                }
            });
        }
        function selectNote(noteId) {
            currentNoteId = noteId;
            const currentNote = notes.find(n => n.id === currentNoteId);
            if (currentNote) {
                document.getElementById('noteTitle').value = currentNote.title || '';
                document.getElementById('noteContent').value = currentNote.content || '';
            } else {
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                 currentNoteId = null; 
            }
            document.querySelectorAll('.note-item').forEach(item => item.classList.remove('active'));
            const activeNoteElement = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
            if (activeNoteElement) activeNoteElement.classList.add('active');
        }
        async function saveNote(showNotif = true) {
            if (currentNoteId) {
                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (noteIndex > -1) {
                    const updatedTitle = document.getElementById('noteTitle').value.trim() || getTranslation("notes.untitledNote");
                    const updatedContent = document.getElementById('noteContent').value;
                    const dataToUpdate = {
                        title: updatedTitle,
                        content: updatedContent,
                    };
                    const updatedNoteFromDB = await DatabaseManager.update('notes', currentNoteId, dataToUpdate);
                    if (updatedNoteFromDB) {
                        notes[noteIndex] = {...notes[noteIndex], ...updatedNoteFromDB, updated: new Date(updatedNoteFromDB.updated_at), created: new Date(updatedNoteFromDB.created_at) };
                        renderNotes(); 
                        selectNote(currentNoteId); 
                        if(showNotif) showNotification(getTranslation("notification.success.noteSaved"), 'success');
                    }
                }
            }
        }
        async function deleteNote() {
            if (currentNoteId) {
                deleteNoteConfirmation(currentNoteId);
            } else {
                showNotification(getTranslation("notification.warning.noNoteSelectedDelete"), "warning");
            }
        }
        let autoSaveTimeoutId = null;
        function autoSaveNote() {
            clearTimeout(autoSaveTimeoutId);
            autoSaveTimeoutId = setTimeout(() => saveNote(false), 1500); 
        }
        function formatText(command) { console.warn("formatText no implementado completamente."); }
        function insertList() { console.warn("insertList no implementado completamente."); }

        // --- Gestión de Calendario y Eventos ---
        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            if(!grid || !title) return;

            const months = currentLanguage === 'es' ? 
                ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'] :
                ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const dayHeaders = currentLanguage === 'es' ?
                ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'] :
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            title.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            grid.innerHTML = '';

            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day calendar-header-day';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const firstDayOfWeek = firstDayOfMonth.getDay(); 
            const daysInMonth = lastDayOfMonth.getDate();

            for (let i = 0; i < firstDayOfWeek; i++) {
                grid.appendChild(document.createElement('div')).className = 'calendar-day empty';
            }

            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.setAttribute('data-day', day);

                if (today.getDate() === day && today.getMonth() === currentDate.getMonth() && today.getFullYear() === currentDate.getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                const currentDateForFilter = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dayEvents = events.filter(event => {
                    if (!event.date || typeof event.date !== 'string') { 
                        console.warn(`Evento con ID ${event.id} tiene fecha faltante o inválida en generateCalendar. Omitiendo.`);
                        return false;
                    }
                    const eventDateParts = event.date.split('-'); 
                    if (eventDateParts.length !== 3) { 
                        console.warn(`Formato de fecha inválido para evento ID ${event.id}: ${event.date}. Omitiendo.`);
                        return false;
                    }
                    const eventDate = new Date(Date.UTC(parseInt(eventDateParts[0]), parseInt(eventDateParts[1]) - 1, parseInt(eventDateParts[2])));
                    const calendarDayDate = new Date(Date.UTC(currentDateForFilter.getFullYear(), currentDateForFilter.getMonth(), currentDateForFilter.getDate()));
                    return eventDate.getTime() === calendarDayDate.getTime();
                });


                if (dayEvents.length > 0) {
                    dayElement.classList.add('has-events');
                    const eventIndicator = document.createElement('span');
                    eventIndicator.className = 'event-indicator';
                    eventIndicator.title = `${dayEvents.length} evento(s)`;
                    dayElement.appendChild(eventIndicator);
                }

                dayElement.addEventListener('click', () => selectDate(day));
                grid.appendChild(dayElement);
            }
        }
        function previousMonth() { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(); }
        function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(); }
        function todayView() { currentDate = new Date(); generateCalendar(); }
        function selectDate(day) {
            const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            document.getElementById('eventDateInput').value = selectedDate.toISOString().split('T')[0];
            document.getElementById('eventDescriptionInput').value = '';
            addEvent(); 
        }
        function addEvent() {
            document.getElementById('eventTitleInput').value = '';
            document.getElementById('eventTimeInput').value = '';
            document.getElementById('eventDescriptionInput').value = '';
            if(!document.getElementById('eventDateInput').value) { 
                 document.getElementById('eventDateInput').value = new Date().toISOString().split('T')[0];
            }
            document.getElementById('eventModal').classList.add('active');
        }
        async function confirmAddEvent() {
            const title = document.getElementById('eventTitleInput').value.trim();
            const date = document.getElementById('eventDateInput').value;
            const time = document.getElementById('eventTimeInput').value;
            const description = document.getElementById('eventDescriptionInput').value.trim();

            if (title && date) {
                const newEventData = { title, date, time, description };
                const createdEvent = await DatabaseManager.create('events', newEventData);
                if (createdEvent) {
                    events.push({...createdEvent, id: createdEvent.id, created: new Date(createdEvent.created_at), date: createdEvent.date.split('T')[0], description: createdEvent.description });
                    generateCalendar();
                    closeModal('eventModal');
                    showNotification(getTranslation("notification.success.eventCreated"), 'success');
                }
            } else {
                showNotification(getTranslation("notification.warning.eventFormError"), 'warning');
            }
        }

        // --- Utilidades (Modales, Notificaciones, etc.) ---
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.remove('active');
        }
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.add('active');
        }
        function showDatabaseConfig() { document.getElementById('databaseModal').classList.add('active'); }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification slide-in ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('slide-in');
                notification.classList.add('slide-out');
                setTimeout(() => notification.remove(), 500); 
            }, duration); 
        }

        function showCustomConfirm(message, onConfirm) {
            const existingModal = document.querySelector('.custom-confirm-modal');
            if (existingModal) existingModal.remove();

            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal active custom-confirm-modal'; 
            confirmModal.innerHTML = `
                <div class="modal-content">
                    <p style="margin-bottom: 1.5rem; color: var(--text-primary);">${message}</p>
                    <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                        <button class="btn btn-secondary" id="customConfirmCancel">${getTranslation("confirm.cancel") || "Cancelar"}</button>
                        <button class="btn" id="customConfirmOk">${getTranslation("confirm.ok") || "Confirmar"}</button>
                    </div>
                </div>`;
            document.body.appendChild(confirmModal);

            document.getElementById('customConfirmOk').onclick = () => { onConfirm(); confirmModal.remove(); };
            document.getElementById('customConfirmCancel').onclick = () => confirmModal.remove();
        }

        function updateDateTime() { /* Implementar si es necesario */ }
        function toggleView() {
            const icon = document.getElementById('viewIcon');
            const gridContainer = document.getElementById('foldersGrid'); 
            const filesGridContainer = document.getElementById('filesGrid');

            if(!icon) return;

            const applyViewChange = (container) => {
                if (!container) return;
                if (icon.classList.contains('fa-th')) { 
                    container.classList.add('list-view');
                    container.classList.remove('grid-view'); 
                } else { 
                    container.classList.add('grid-view');
                    container.classList.remove('list-view');
                }
            };

            if (icon.classList.contains('fa-th')) {
                icon.className = 'fas fa-list'; 
            } else {
                icon.className = 'fas fa-th'; 
            }

            if (currentSection === 'folders' && gridContainer) applyViewChange(gridContainer);
            if (currentSection === 'files' && filesGridContainer) applyViewChange(filesGridContainer);
        }


        function loadSampleData() {
            folders = [ { id: 'sample-101', name: 'Documentos (Muestra)', created: new Date() }, { id: 'sample-102', name: 'Proyectos (Muestra)', created: new Date() }];
            notes = [ { id: 'sample-201', title: 'Nota de Bienvenida (Muestra)', content: 'Empieza a organizar tus ideas. Esta es una nota de muestra cargada porque no se pudo conectar a la base de datos.', created: new Date(), updated: new Date(), pinned: true }];
            files = [ {id: 'sample-301', file_name: "ejemplo_local.pdf", size: 102400, type: "application/pdf", uploaded: new Date(), url: "#", file: new File(["sample pdf content"], "ejemplo_local.pdf", {type: "application/pdf"})}];
            events = [ { id: 'sample-401', title: 'Reunión Inicial (Muestra)', date: new Date().toISOString().split('T')[0], time: '10:00', description: 'Discutir objetivos del proyecto. Evento de muestra.', created: new Date() }];
            if (notes.length > 0) currentNoteId = notes[0].id;
            console.log("Datos de muestra cargados como fallback.");
        }

        function cleanUrl(url) {
            if (typeof url !== 'string') return url;
            let cleaned = url.replace(/^(https?|ftp):[\/]{2,}/i, '$1://'); 
            cleaned = cleaned.replace(/([^:])\/\/+/g, '$1/'); 
            return cleaned;
        }

        function openFilePreviewModal(fileObject) {
            const modal = document.getElementById('filePreviewModal');
            const titleElement = document.getElementById('filePreviewTitle');
            const imgElement = document.getElementById('filePreviewImage');
            const videoElement = document.getElementById('filePreviewVideo');
            const audioElement = document.getElementById('filePreviewAudio');
            const iframeElement = document.getElementById('filePreviewIframe'); 
            const textElement = document.getElementById('filePreviewText');
            const fallbackElement = document.getElementById('filePreviewFallback');
            const downloadLink = document.getElementById('fileDownloadLink');

            [imgElement, videoElement, audioElement, iframeElement, textElement, fallbackElement].forEach(el => {
                el.style.display = 'none';
                if (el.tagName === 'IMG' || el.tagName === 'VIDEO' || el.tagName === 'AUDIO' || el.tagName === 'IFRAME') {
                    el.removeAttribute('src'); 
                }
                if (el.tagName === 'PRE') {
                    el.textContent = '';
                }
            });

            titleElement.textContent = fileObject.file_name || getTranslation("modal.filePreview.title");
            let previewSrc = null;
            let canDownload = false;

            if (fileObject.url && typeof fileObject.url === 'string') {
                previewSrc = cleanUrl(fileObject.url);
                downloadLink.href = previewSrc;
                downloadLink.download = fileObject.file_name || 'archivo';
                downloadLink.style.display = 'inline-block';
                canDownload = true;
                console.log("File Preview: Using Supabase URL (cleaned):", previewSrc);
            } else if (fileObject.file && fileObject.file instanceof File) { 
                previewSrc = URL.createObjectURL(fileObject.file);
                downloadLink.href = previewSrc;
                downloadLink.download = fileObject.file_name || 'archivo';
                downloadLink.style.display = 'inline-block';
                canDownload = true;
                console.log("File Preview: Using local Object URL.");
            } else {
                fallbackElement.textContent = getTranslation("notification.error.noFileForPreview");
                fallbackElement.style.display = 'block';
                downloadLink.style.display = 'none';
                openModal('filePreviewModal');
                return;
            }

            const fileType = fileObject.type || '';
            console.log(`File Preview: Attempting to preview ${fileObject.file_name}, Type: ${fileType}, Source: ${previewSrc}`);

            let previewed = false;
            if (previewSrc) {
                if (fileType.startsWith('image/')) {
                    imgElement.src = previewSrc;
                    imgElement.style.display = 'block';
                    previewed = true;
                } else if (fileType.startsWith('video/')) {
                    videoElement.src = previewSrc;
                    videoElement.style.display = 'block';
                    videoElement.load();
                    previewed = true;
                } else if (fileType.startsWith('audio/')) {
                    audioElement.src = previewSrc;
                    audioElement.style.display = 'block';
                    audioElement.load();
                    previewed = true;
                } else if (fileType.includes('pdf')) { 
                    const pdfjsViewerUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(previewSrc)}`;
                    console.log("File Preview: PDF detected. Setting iframe source to PDF.js viewer:", pdfjsViewerUrl);
                    iframeElement.src = pdfjsViewerUrl;
                    iframeElement.style.display = 'block';
                    previewed = true;
                } else if (fileType.startsWith('text/') && fileObject.file && !fileObject.url) { 
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        textElement.textContent = e.target.result;
                        textElement.style.display = 'block';
                    }
                    reader.onerror = function() {
                        fallbackElement.textContent = getTranslation("notification.error.fileTextReadError");
                        fallbackElement.style.display = 'block';
                    }
                    reader.readAsText(fileObject.file);
                    previewed = true; 
                }
            }

            if (!previewed) { 
                 if (fileObject.url || (fileObject.file && fileObject.file instanceof File)) { 
                    fallbackElement.textContent = `${getTranslation("notification.info.genericPreviewNotAvailable")} (${fileType || 'desconocido'}). ${getTranslation("modal.filePreview.downloadSuggestion") || "Puedes intentar descargarlo."}`;
                } else { 
                    fallbackElement.textContent = getTranslation("notification.error.noFileForPreview");
                }
                fallbackElement.style.display = 'block';
            }
            
            if (!canDownload) { 
                downloadLink.style.display = 'none';
            }

            openModal('filePreviewModal');
        }

        // --- Lógica de Notificación de Eventos ---
        function checkUpcomingEvents() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];

            events.forEach(event => {
                if (event.date === todayStr && event.time && !notifiedEventIdsThisSession.has(event.id)) {
                    const [hours, minutes] = event.time.split(':');
                    const eventDateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(hours), parseInt(minutes));
                    
                    const timeDifferenceMs = now.getTime() - eventDateTime.getTime();
                    const fiveMinutesMs = 5 * 60 * 1000;
                    
                    if (timeDifferenceMs >= 0 && timeDifferenceMs < fiveMinutesMs) { 
                        triggerEventNotification(event);
                        notifiedEventIdsThisSession.add(event.id);
                    } 
                }
            });
        }

        function triggerEventNotification(event) {
            console.log("Disparando notificación para el evento:", event.title);
            const titleElement = document.getElementById('eventNotificationTitle');
            const timeElement = document.getElementById('eventNotificationTime');
            const descriptionElement = document.getElementById('eventNotificationDescription');

            if (titleElement) titleElement.textContent = `${getTranslation("modal.eventNotification.titlePrefix") || "🔔 ¡Recordatorio!"} ${event.title}`;
            if (timeElement) timeElement.textContent = `${getTranslation("modal.event.date")}: ${event.date}, ${getTranslation("modal.event.time")}: ${event.time}`;
            if (descriptionElement) descriptionElement.textContent = event.description || (getTranslation("modal.eventNotification.noDescription") || "Sin descripción adicional.");
            
            openModal('eventNotificationModal');
            
            try {
                const notificationSound = new Audio('https://cdn.jsdelivr.net/npm/ion-sound@3.0.7/sounds/water_droplet.mp3'); 
                notificationSound.play().catch(e => console.warn("No se pudo reproducir sonido de notificación:", e));
            } catch (e) {
                console.warn("Error al intentar reproducir sonido:", e);
            }
        }

        function startEventNotificationChecks() {
            if (checkUpcomingEventsInterval) {
                clearInterval(checkUpcomingEventsInterval);
            }
            checkUpcomingEventsInterval = setInterval(checkUpcomingEvents, 60000); 
            checkUpcomingEvents(); 
        }


        // --- Event Listeners Adicionales (Teclado, etc.) ---
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal') && !e.target.classList.contains('custom-confirm-modal')) {
                if (!e.target.closest('.custom-confirm-modal .modal-content')) {
                     e.target.classList.remove('active');
                }
            }
        });

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { 
                e.preventDefault();
                if (currentSection === 'notes' && currentNoteId) {
                    saveNote();
                }
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') { 
                e.preventDefault();
                if (currentSection === 'notes') createNote();
                else if (currentSection === 'folders') createFolder();
            }
            if (e.key === 'Escape') { 
                document.querySelectorAll('.modal.active').forEach(modal => {
                    if (!modal.classList.contains('custom-confirm-modal')) {
                        modal.classList.remove('active');
                    }
                });
            }
        });

        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
             const mainContent = document.getElementById('mainContent');
            if (window.innerWidth > 768) {
                if(sidebar.classList.contains('show')){
                }
            } else {
            }
        });

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.closest('.modal-content')) {
                e.preventDefault(); 
                if (e.target.id === 'folderNameInput') confirmCreateFolder();
                else if (e.target.id === 'eventTitleInput' || e.target.id === 'eventDateInput' || e.target.id === 'eventTimeInput') {
                     if(e.target.id === 'eventTimeInput' || (document.getElementById('eventTitleInput').value && document.getElementById('eventDateInput').value)) {
                        confirmAddEvent();
                     }
                }
            }
        });


        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { /* Aquí iría el registro del Service Worker si se usara */ });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const toggles = document.querySelectorAll('.settings-container .toggle-switch');
            toggles.forEach(toggle => {
                if (toggle.id === 'darkModeToggle') {
                }
                toggle.addEventListener('click', function() {
                    if (this.id === 'darkModeToggle') {
                    } else {
                        this.classList.toggle('active');
                        const settingKey = this.id.replace('Toggle', '');
                        localStorage.setItem(settingKey + 'Preference', this.classList.contains('active'));
                        console.log(`Setting ${settingKey} changed to: ${this.classList.contains('active')}`);
                    }
                });

                 if (toggle.id !== 'darkModeToggle') { 
                    const settingKey = toggle.id.replace('Toggle', '');
                    const savedPreference = localStorage.getItem(settingKey + 'Preference');
                    if (savedPreference !== null) {
                        toggle.classList.toggle('active', savedPreference === 'true');
                    }
                }
            });
        });


        window.MySpaceApp = { showSection, createFolder, createNote, saveNote, addEvent, setTheme, setLanguage, DatabaseManager, folders, notes, files, events, processFiles };

        console.log('Mi Espacio Inteligente - Aplicación cargada y lista.');
    </script>
</body>
</html>

