<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Espacio Inteligente</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary-bg: #0a0e27;
            --secondary-bg: #1a1f3a;
            --accent-color: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --hover-bg: #252b4a;
            --card-bg: #1e2347;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff4757;
            --border-color: #30375a;
        }
        [data-theme="light"] {
            --primary-bg: #f8fafc;
            --secondary-bg: #ffffff;
            --accent-color: #3b82f6;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --hover-bg: #e2e8f0;
            --card-bg: #ffffff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --border-color: #cbd5e1;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            font-size: 16px;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--secondary-bg);
            padding: 2rem 0;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        .sidebar.show {
            transform: translateX(0);
        }
        .logo {
            text-align: center;
            margin-bottom: 2rem;
            padding: 0 1.5rem;
        }
        .logo h2 {
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .nav-menu {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
        }
        .nav-item {
            margin: 0.25rem 0;
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.9rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
            font-weight: 500;
        }
        .nav-link:hover,
        .nav-link.active {
            background: var(--hover-bg);
            color: var(--text-primary);
            border-left-color: var(--accent-color);
        }
        .nav-link.active {
            color: var(--accent-color);
        }
        .nav-link i {
            margin-right: 1rem;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            transition: margin-left 0.3s ease;
        }
        .main-content.expanded {
            margin-left: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .menu-toggle {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            transition: background-color 0.2s ease;
        }
        .menu-toggle:hover {
            background-color: var(--success-color);
        }
        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .theme-toggle,
        .lang-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .theme-toggle:hover,
        .lang-toggle:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
            border-color: var(--accent-color);
        }
        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .content-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Home Section */
        .hero {
            text-align: center;
            padding: 3rem 1rem;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), transparent);
            border-radius: 20px;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color);
        }
        .hero h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        .hero p {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .cta-button, .ai-tip-button {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
            padding: 0.9rem 2.2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
            margin-top: 1rem;
        }
         .ai-tip-button .fas {
            margin-right: 0.5em;
        }
        .cta-button:hover, .ai-tip-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 212, 255, 0.3);
        }
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .card {
            background: var(--card-bg);
            padding: 1.8rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
            border-color: var(--accent-color);
        }
        .card-icon {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
            line-height: 1;
        }
        .card h3 {
            font-size: 1.3rem;
            margin-bottom: 0.8rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        .card p {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
            flex-grow: 1;
        }
        /* Folders Section & Files Section (estilos compartidos para grids) */
        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.7rem 1.3rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            font-size: 0.95rem;
        }
         .btn .fas {
            margin-right: 0.3em;
        }
        .btn:hover {
            background: var(--success-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
        }
        .folders-grid, .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
        }
        /* Estilos para vista de lista */
        .folders-grid.list-view, .files-grid.list-view {
            grid-template-columns: 1fr;
        }
        .folders-grid.list-view .folder-item,
        .files-grid.list-view .file-item {
            text-align: left;
            display: flex;
            align-items: center;
            padding: 1rem;
            position: relative; /* Para el botón de borrar */
        }
        .files-grid.list-view .file-item .delete-file-icon {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            padding: 0.5rem;
        }
        .folders-grid.list-view .folder-icon,
        .files-grid.list-view .file-icon {
            font-size: 1.5rem;
            margin-bottom: 0;
            margin-right: 1rem;
        }
        .folders-grid.list-view .folder-name,
        .files-grid.list-view .file-name {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .folders-grid.list-view .folder-stats,
        .files-grid.list-view .file-size {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-right: 2.5rem; /* Espacio para el botón de borrar */
        }
        .folder-item, .file-item {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative; /* Para el botón de borrar en vista grid */
        }
        .file-item .delete-file-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: var(--danger-color);
            background-color: rgba(0,0,0,0.2);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .file-item:hover .delete-file-icon {
            opacity: 1;
        }
        .file-item .delete-file-icon:hover {
            background-color: var(--danger-color);
            color: white;
        }
        .folder-item:hover, .file-item:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .folder-icon, .file-icon {
            font-size: 2.8rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        .folder-name, .file-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .folder-stats, .file-size {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--accent-color);
            border-radius: 15px;
            padding: 2.5rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
            background: rgba(0, 212, 255, 0.03);
            cursor: pointer;
        }
        .drop-zone.dragover {
            background: rgba(0, 212, 255, 0.08);
            border-color: var(--success-color);
            transform: scale(1.02);
        }
        .drop-zone i {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        .drop-zone h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .drop-zone p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        /* Notes Section */
        .notes-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 12rem);
            min-height: 500px;
        }
        .notes-list {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1rem;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .notes-list h3 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.1rem;
        }
        .note-item {
            padding: 0.9rem;
            margin-bottom: 0.5rem;
            background: var(--hover-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .note-item:hover {
            background: var(--primary-bg);
            border-color: var(--accent-color);
        }
        .note-item.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .note-item.active strong, .note-item.active div {
            color: white !important;
        }
        .note-item.active .pin-note, .note-item.active .delete-note-icon {
            color: white !important;
        }
        .note-editor {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .editor-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 40px;
        }
         .editor-btn .fas, .editor-btn .ai-icon {
            margin-right: 0.3em;
        }
        .editor-btn:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
        }
        .note-title {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 2px solid var(--border-color);
            outline: none;
            width: 100%;
        }
        .note-title:focus {
            border-bottom-color: var(--accent-color);
        }
        .note-content {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.7;
            resize: none;
            outline: none;
            padding: 0.5rem 0;
            width: 100%;
        }
        /* Calendar Section */
        .calendar-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid var(--border-color);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .calendar-nav {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        .calendar-nav:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .calendar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .calendar-day {
            background: var(--card-bg);
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-weight: 500;
            position: relative;
        }
        .calendar-day.calendar-header-day {
            background: var(--secondary-bg);
            color: var(--text-secondary);
            font-weight: bold;
            cursor: default;
            min-height: auto;
            padding: 0.5rem;
        }
        .calendar-day:hover:not(.calendar-header-day):not(.empty) {
            background: var(--hover-bg);
        }
        .calendar-day.empty {
            background: var(--secondary-bg);
            cursor: default;
        }
        .calendar-day.today {
            background: var(--accent-color);
            color: white;
            font-weight: bold;
            border-radius: 4px;
        }
        .calendar-day.today:hover {
            background: var(--success-color);
        }
        .calendar-day.has-events .event-indicator {
            width: 8px;
            height: 8px;
            background-color: var(--danger-color);
            border-radius: 50%;
            display: inline-block;
            margin-top: 0.3rem;
        }
        .calendar-day.today.has-events .event-indicator {
            background-color: white;
        }
        /* Files Section Specifics */
        .files-header {
            /* ... */
        }
        .search-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 25px;
            outline: none;
            min-width: 250px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .search-box:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .filter-btn.active,
        .filter-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        /* Settings Section */
        .settings-container {
            max-width: 700px;
            margin: 0 auto;
        }
        .settings-group {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        .settings-group h3 {
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        .setting-control {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--hover-bg);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .toggle-switch.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        .dropdown {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            outline: none;
            min-width: 150px;
        }
        .dropdown:focus {
            border-color: var(--accent-color);
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            animation: fadeInModal 0.3s ease-out;
            overflow-y: auto;
            padding: 1rem;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            max-width: 550px;
            width: 100%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideInModal 0.3s ease-out;
            border: 1px solid var(--border-color);
        }
        @keyframes slideInModal {
            from { transform: translateY(-30px) scale(0.95); opacity: 0.5; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0.5rem;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--danger-color);
        }
        .modal-title {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group:last-child {
            margin-bottom: 0;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }
        .form-input, .form-textarea {
            width: 100%;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.8rem;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s ease;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-input:focus, .form-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
            background: var(--primary-bg);
        }
        .form-input[type="date"], .form-input[type="time"] {
            color-scheme: var(--current-theme, dark);
        }
        body[data-theme="light"] .form-input[type="date"],
        body[data-theme="light"] .form-input[type="time"] {
            color-scheme: light;
        }
        /* Database Connection Status */
        .db-status {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--card-bg);
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            border-left: 4px solid var(--warning-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .db-status.connected {
            border-left-color: var(--success-color);
        }
        .db-status.connected i {
            color: var(--success-color);
        }
        .db-status i {
            color: var(--warning-color);
        }
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            font-weight: 500;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateX(120%);
            opacity: 0;
        }
        .notification.slide-in {
            transform: translateX(0);
            opacity: 1;
        }
        .notification.slide-out {
            transform: translateX(120%);
            opacity: 0;
        }
        .notification.success { background: var(--success-color); }
        .notification.error   { background: var(--danger-color); }
        .notification.warning { background: var(--warning-color); }
        .notification.info    { background: var(--accent-color); }
        /* Modal de Confirmación Personalizado y File Preview Modal */
        .custom-confirm-modal .modal-content,
        #filePreviewModal .modal-content,
        #tipModal .modal-content {
            max-width: 450px;
        }
        #filePreviewModal .modal-content {
            max-width: 80vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        #filePreviewModal .modal-body {
            flex-grow: 1;
            overflow-y: auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px; 
        }
        #filePreviewImage, #filePreviewVideo, #filePreviewPdfJsViewer /* Cambiado de Embed a Iframe */ {
            max-width: 100%;
            max-height: 70vh; 
            object-fit: contain; 
            border-radius: 8px; 
        }
         #filePreviewAudio {
            width: 100%;
            max-width: 500px; 
        }
        #filePreviewText {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 8px;
            max-height: 70vh;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
            width: 100%;
            text-align: left;
        }
        /* Responsive Design */
        @media (max-width: 992px) {
            .notes-container {
                grid-template-columns: 220px 1fr;
            }
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: none;
            }
            .sidebar.show {
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                width: 250px;
            }
            .main-content {
                margin-left: 0;
                padding: 1.5rem;
            }
            .menu-toggle {
                display: block;
            }
            .header-title {
                font-size: 1.5rem;
            }
            .header-controls {
                gap: 0.5rem;
            }
            .theme-toggle, .lang-toggle {
                padding: 0.6rem;
            }
            .lang-toggle span { display: none; }
            .cards-grid {
                grid-template-columns: 1fr;
            }
            .notes-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .notes-list {
                max-height: 250px;
                margin-bottom: 1rem;
            }
            .calendar-day {
                min-height: 50px;
                font-size: 0.85rem;
                padding: 0.5rem;
            }
            .calendar-day.calendar-header-day {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
            .files-header, .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .search-box {
                min-width: auto;
                width: 100%;
            }
            .filter-buttons {
                justify-content: center;
            }
            .settings-container {
                padding: 0 0.5rem;
            }
            .settings-group {
                padding: 1.5rem;
            }
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
            #filePreviewModal .modal-content {
                max-width: 90vw;
                max-height: 85vh;
            }
            .db-status {
                bottom: 1rem;
                right: 1rem;
                padding: 0.6rem 1rem;
            }
            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                text-align: center;
            }
        }
        /* Animaciones Adicionales */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.98); }
        }
        .loading-indicator {
            animation: pulse 1.5s infinite ease-in-out;
        }
        /* Loading Overlay for Gemini API */
        .loading-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9998; /* Below modals but above most content */
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-overlay .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            width: 50px;
            height: 50px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <h2><i class="fas fa-brain"></i> Mi Espacio IA</h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="home">
                        <i class="fas fa-home"></i>
                        <span data-translate="nav.home">Inicio</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="folders">
                        <i class="fas fa-folder"></i>
                        <span data-translate="nav.folders">Mis Carpetas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="notes">
                        <i class="fas fa-sticky-note"></i>
                        <span data-translate="nav.notes">Bloc de Notas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="calendar">
                        <i class="fas fa-calendar"></i>
                        <span data-translate="nav.calendar">Calendario</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="files">
                        <i class="fas fa-file"></i>
                        <span data-translate="nav.files">Archivos Subidos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span data-translate="nav.settings">Configuración</span>
                    </a>
                </li>
            </ul>
        </nav>
        <main class="main-content" id="mainContent">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title" data-translate="header.title">Mi Espacio Inteligente</h1>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="lang-toggle" id="langToggle">
                        <i class="fas fa-globe"></i> ES
                    </button>
                </div>
            </header>
            <section class="content-section active" id="home">
                <div class="hero">
                    <h1 data-translate="home.title">Bienvenido a tu Espacio Inteligente</h1>
                    <p data-translate="home.subtitle">Donde la inteligencia artificial se encuentra con tu productividad personal</p>
                    <button class="cta-button" onclick="showSection('folders')" data-translate="home.cta">
                        Comenzar Ahora
                    </button>
                    <button class="ai-tip-button" id="dailyTipBtn">
                        <i class="fas fa-lightbulb"></i> <span data-translate="home.aiTip">Consejo del Día</span>
                    </button>
                </div>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-folder-open"></i></div>
                        <h3 data-translate="home.cards.folders.title">Gestión de Carpetas</h3>
                        <p data-translate="home.cards.folders.desc">Organiza tus archivos de manera inteligente con carpetas personalizadas y clasificación automática.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-edit"></i></div>
                        <h3 data-translate="home.cards.notes.title">Notas Inteligentes</h3>
                        <p data-translate="home.cards.notes.desc">Crea, edita y organiza tus ideas con un editor enriquecido y sugerencias de IA.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
                        <h3 data-translate="home.cards.calendar.title">Calendario Personal</h3>
                        <p data-translate="home.cards.calendar.desc">Planifica tu día con recordatorios inteligentes y gestión avanzada de eventos.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-robot"></i></div>
                        <h3 data-translate="home.cards.ai.title">Asistente IA</h3>
                        <p data-translate="home.cards.ai.desc">Tu compañero inteligente para responder preguntas y sugerir mejoras en tu flujo de trabajo.</p>
                    </div>
                </div>
            </section>
             <section class="content-section" id="folders">
                <div class="toolbar">
                    <button class="btn" onclick="createFolder()">
                        <i class="fas fa-plus"></i>
                        <span data-translate="folders.create">Nueva Carpeta</span>
                    </button>
                    <button class="btn btn-secondary" onclick="uploadFile()"> <i class="fas fa-upload"></i>
                        <span data-translate="folders.upload">Subir Archivo (a Carpeta Actual)</span>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleView()">
                        <i class="fas fa-th" id="viewIcon"></i>
                        <span data-translate="folders.view">Vista</span>
                    </button>
                </div>
                <div class="drop-zone" id="dropZoneFolders">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3 data-translate="folders.dropzone.title">Arrastra archivos a la carpeta actual</h3>
                    <p data-translate="folders.dropzone.desc">O haz clic en "Subir Archivo"</p>
                </div>
                <div class="folders-grid" id="foldersGrid">
                    </div>
            </section>
            <section class="content-section" id="notes">
                <div class="toolbar">
                    <button class="btn" onclick="createNote()">
                        <i class="fas fa-plus"></i>
                        <span data-translate="notes.create">Nueva Nota</span>
                    </button>
                    <button class="btn btn-secondary" onclick="saveNote()">
                        <i class="fas fa-save"></i>
                        <span data-translate="notes.save">Guardar</span>
                    </button>
                    <button class="btn btn-secondary" onclick="deleteNote()">
                        <i class="fas fa-trash"></i>
                        <span data-translate="notes.delete">Eliminar</span>
                    </button>
                </div>
                <div class="notes-container">
                    <div class="notes-list">
                        <h3 data-translate="notes.list.title">Mis Notas</h3>
                        <div id="notesList">
                            </div>
                    </div>
                    <div class="note-editor">
                        <div class="editor-toolbar">
                            <button class="editor-btn" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                            <button class="editor-btn" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                            <button class="editor-btn" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                            <button class="editor-btn" onclick="insertList()"><i class="fas fa-list"></i></button>
                            <button class="editor-btn" id="summarizeNoteBtn" title="Resumir Nota con IA"><i class="fas fa-star ai-icon"></i> Resumir</button>
                            <button class="editor-btn" id="continueWritingBtn" title="Continuar Escritura con IA"><i class="fas fa-pen-fancy ai-icon"></i> Continuar</button>
                        </div>
                        <input type="text" class="note-title" id="noteTitle" placeholder="Título de la nota..." data-translate="notes.title.placeholder">
                        <textarea class="note-content" id="noteContent" placeholder="Escribe tu nota aquí..." data-translate="notes.content.placeholder"></textarea>
                    </div>
                </div>
            </section>
            <section class="content-section" id="calendar">
                <div class="toolbar">
                    <button class="btn" onclick="addEvent()">
                        <i class="fas fa-plus"></i>
                        <span data-translate="calendar.addEvent">Nuevo Evento</span>
                    </button>
                    <button class="btn btn-secondary" onclick="todayView()">
                        <i class="fas fa-calendar-day"></i>
                        <span data-translate="calendar.today">Hoy</span>
                    </button>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
                        <h2 class="calendar-title" id="calendarTitle">Enero 2024</h2>
                        <button class="calendar-nav" onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        </div>
                </div>
            </section>
            <section class="content-section" id="files">
                 <div class="toolbar">
                     <button class="btn" onclick="triggerFileInput()">
                        <i class="fas fa-upload"></i>
                        <span data-translate="files.uploadGeneral">Subir Nuevo Archivo</span>
                    </button>
                </div>
                <div class="drop-zone" id="dropZoneFiles">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3 data-translate="files.dropzone.title">Arrastra y suelta archivos aquí para subirlos</h3>
                    <p data-translate="files.dropzone.desc">O haz clic en "Subir Nuevo Archivo"</p>
                </div>
                <hr style="margin: 2rem 0; border-color: var(--border-color);">
                <div class="files-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <input type="text" class="search-box" placeholder="Buscar en mis archivos..." data-translate="files.search.placeholder" id="fileSearch">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-translate="files.filter.all">Todos</button>
                        <button class="filter-btn" data-filter="image" data-translate="files.filter.images">Imágenes</button>
                        <button class="filter-btn" data-filter="document" data-translate="files.filter.documents">Documentos</button>
                        <button class="filter-btn" data-filter="video" data-translate="files.filter.videos">Videos</button>
                        <button class="filter-btn" data-filter="audio" data-translate="files.filter.audio">Audio</button>
                    </div>
                </div>
                <div class="files-grid" id="filesGrid">
                    </div>
            </section>
            <section class="content-section" id="settings">
                <div class="settings-container">
                    <div class="settings-group">
                        <h3 data-translate="settings.appearance.title">Apariencia</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.appearance.theme">Modo Oscuro</span>
                            <div class="setting-control">
                                <div class="toggle-switch active" id="darkModeToggle"><div class="toggle-slider"></div></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.appearance.font">Tamaño de Fuente</span>
                            <div class="setting-control">
                                <select class="dropdown" id="fontSizeSelect">
                                    <option value="small">Pequeño</option>
                                    <option value="medium" selected>Mediano</option>
                                    <option value="large">Grande</option>
                                </select>
                            </div>
                        </div>
                    </div>
                     <div class="settings-group">
                        <h3 data-translate="settings.language.title">Idioma</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.language.select">Idioma de la Interfaz</span>
                            <div class="setting-control">
                                <select class="dropdown" id="languageSelect">
                                    <option value="es">Español</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3 data-translate="settings.ai.title">Configuración de IA</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.ai.suggestions">Sugerencias Automáticas</span>
                            <div class="setting-control">
                                <div class="toggle-switch active" id="aiSuggestionsToggle"><div class="toggle-slider"></div></div>
                            </div>
                        </div>
                         <div class="setting-item">
                            <span class="setting-label" data-translate="settings.ai.voice">Reconocimiento de Voz</span>
                            <div class="setting-control">
                                <div class="toggle-switch" id="voiceToggle"><div class="toggle-slider"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3 data-translate="settings.database.title">Configuración de Base de Datos</h3>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.database.status">Estado de Conexión</span>
                            <div class="setting-control">
                                <span id="dbConnectionStatus" class="badge" style="color: var(--warning-color);">
                                    <i class="fas fa-exclamation-triangle"></i> Pendiente de Configuración
                                </span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label" data-translate="settings.database.config">Configurar Conexión</span>
                            <div class="setting-control">
                                <button class="btn btn-secondary" onclick="showDatabaseConfig()">
                                    <i class="fas fa-database"></i> Configurar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('folderModal')"><i class="fas fa-times"></i></button>
            <h3 class="modal-title" data-translate="modal.folder.title">Nueva Carpeta</h3>
            <div class="form-group">
                <label class="form-label" data-translate="modal.folder.name">Nombre de la carpeta:</label>
                <input type="text" class="form-input" id="folderNameInput" placeholder="Mi nueva carpeta">
            </div>
            <div class="form-group">
                <button class="btn" onclick="confirmCreateFolder()"><i class="fas fa-check"></i> <span data-translate="modal.folder.create">Crear Carpeta</span></button>
            </div>
        </div>
    </div>
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('eventModal')"><i class="fas fa-times"></i></button>
            <h3 class="modal-title" data-translate="modal.event.title">Nuevo Evento</h3>
            <div class="form-group">
                <label class="form-label" data-translate="modal.event.name">Título del evento:</label>
                <input type="text" class="form-input" id="eventTitleInput" placeholder="Mi evento">
            </div>
            <div class="form-group">
                <label class="form-label" for="eventDescriptionInput">Descripción:</label>
                <textarea id="eventDescriptionInput" class="form-textarea" placeholder="Describe tu evento..."></textarea>
            </div>
            <div class="form-group">
                 <button class="btn btn-secondary" id="suggestEventDetailsBtn" style="width:100%; margin-bottom: 1rem;">
                    <i class="fas fa-lightbulb"></i>  ✨  Sugerir Descripción
                </button>
            </div>
            <div class="form-group">
                <label class="form-label" data-translate="modal.event.date">Fecha:</label>
                <input type="date" class="form-input" id="eventDateInput">
            </div>
            <div class="form-group">
                <label class="form-label" data-translate="modal.event.time">Hora:</label>
                <input type="time" class="form-input" id="eventTimeInput">
            </div>
            <div class="form-group">
                <button class="btn" onclick="confirmAddEvent()"><i class="fas fa-check"></i> <span data-translate="modal.event.create">Crear Evento</span></button>
            </div>
        </div>
    </div>
     <div class="modal" id="databaseModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('databaseModal')"><i class="fas fa-times"></i></button>
            <h3 class="modal-title" data-translate="modal.database.title">Configuración de Base de Datos</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;" data-translate="modal.database.desc">
                Para conectar tu base de datos Supabase, necesitas añadir tu URL de Supabase y tu Clave Anónima (Anon Key)
                directamente en las constantes `SUPABASE_URL` y `SUPABASE_ANON_KEY` al inicio del bloque de código JavaScript.
            </p>
             <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Ejemplo:
                <br>
                <code>const SUPABASE_URL = 'https://tu-proyecto-id.supabase.co';</code>
                <br>
                <code>const SUPABASE_ANON_KEY = 'tu-clave-anon';</code>
            </p>
            <div class="form-group">
                <button class="btn" onclick="closeModal('databaseModal')"><i class="fas fa-check"></i> <span data-translate="modal.database.connect">Entendido</span></button>
            </div>
        </div>
    </div>
    <div class="modal" id="tipModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('tipModal')"><i class="fas fa-times"></i></button>
            <h3 class="modal-title" id="tipModalTitle"> ✨  Consejo del Día</h3>
            <p id="tipModalContent" style="color: var(--text-secondary); line-height: 1.6;">Cargando consejo...</p>
        </div>
    </div>

    <div class="modal" id="filePreviewModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('filePreviewModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title" id="filePreviewTitle">Vista Previa de Archivo</h3>
            <div class="modal-body" id="filePreviewBody" style="text-align: center;">
                <img id="filePreviewImage" alt="Previsualización de Imagen" style="display:none;">
                <video id="filePreviewVideo" style="display:none;" controls></video>
                <audio id="filePreviewAudio" style="display:none;" controls></audio>
                <iframe id="filePreviewPdfJsViewer" style="display:none; width:100%; height:70vh; border: none;" title="Visor de PDF"></iframe>
                <pre id="filePreviewText" style="display:none;"></pre>
                <p id="filePreviewFallback" style="display:none; padding: 1rem; color: var(--text-secondary);"></p>
            </div>
            <div class="form-group" style="margin-top: 1.5rem; text-align: right;">
                <a href="#" id="fileDownloadLink" class="btn btn-secondary" download>
                    <i class="fas fa-download"></i> Descargar
                </a>
            </div>
        </div>
    </div>

    <div class="db-status" id="dbStatus">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-database"></i>
            <span data-translate="db.status.pending">Base de Datos: Pendiente</span>
        </div>
    </div>
    <input type="file" id="fileInput" style="display: none;"> <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

    <script>
        // --- Configuración de Supabase ---
        const SUPABASE_URL = 'https://kuzctbrowwnrwvpvqnky.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1emN0YnJvd3ducnd2cHZxbmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNzAxMDYsImV4cCI6MjA2Mzg0NjEwNn0.52DbeVnoMpGf1OsagJAsgNjje4oC4N2vunBE41uELpw';
        // --- Fin de Configuración de Supabase ---
        let supabase = null;

        // Variables Globales
        let currentSection = 'home';
        let currentTheme = 'dark';
        let currentLanguage = 'es';
        let folders = [];
        let notes = [];
        let files = []; 
        let events = [];
        let currentDate = new Date();
        let currentNoteId = null;

        // --- Gemini API Helper ---
        const GeminiAPIHelper = {
            apiKey: "", 
            apiUrl: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`,
            showLoading: function() { document.getElementById('loadingOverlay').classList.add('active'); },
            hideLoading: function() { document.getElementById('loadingOverlay').classList.remove('active'); },
            generateText: async function(prompt) {
                this.showLoading();
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                try {
                    const finalApiUrl = this.apiKey ? `${this.apiUrl}?key=${this.apiKey}` : this.apiUrl;
                    const response = await fetch(finalApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error('GeminiAPI: Error en la respuesta:', response.status, errorBody);
                        throw new Error(`Error de la API de Gemini: ${response.status}`);
                    }
                    const result = await response.json();
                    this.hideLoading();
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error('GeminiAPI: Respuesta inesperada:', result);
                        if (result.promptFeedback?.blockReason) {
                             throw new Error(`Contenido bloqueado por Gemini: ${result.promptFeedback.blockReason}`);
                        }
                        throw new Error('Respuesta inesperada o vacía de Gemini.');
                    }
                } catch (error) {
                    this.hideLoading();
                    console.error('GeminiAPI: Error al llamar:', error);
                    showNotification(`Error de IA: ${error.message}`, 'error');
                    return null;
                }
            }
        };
        
        // --- DatabaseManager ---
        const DatabaseManager = {
            isConnected: false,
            config: { tables: { folders: 'folders', notes: 'notes', files: 'files', events: 'events' }},
            async connect() {
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    updateDbStatus(false, 'Supabase URL/Key no configuradas.'); return false;
                }
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.isConnected = true; updateDbStatus(true, 'Conectado a Supabase'); return true;
                } catch (error) {
                    this.isConnected = false; updateDbStatus(false, `Error conexión: ${error.message}`); return false;
                }
            },
            async create(table, dataToInsert) { 
                if (!this.isConnected || !supabase) { showNotification('No hay conexión a la base de datos.', 'error'); return null; }
                const { id, ...payload } = dataToInsert; 
                payload.created_at = payload.created_at || new Date().toISOString();
                if (table === 'notes' || table === 'events') { 
                     payload.updated_at = payload.updated_at || payload.created_at;
                } else if (table === 'files') { 
                    payload.uploaded_at = payload.uploaded_at || payload.created_at;
                }
                const { data, error } = await supabase.from(this.config.tables[table]).insert([payload]).select();
                if (error) { console.error(`Error creando en ${table}:`, error); showNotification(`Error al crear: ${error.message}`, 'error'); return null; }
                return data?.[0];
            },
            async read(table) { 
                if (!this.isConnected || !supabase) return [];
                const { data, error } = await supabase.from(this.config.tables[table]).select('*');
                if (error) { console.error(`Error leyendo de ${table}:`, error); showNotification(`Error al leer: ${error.message}`, 'error'); return []; }
                return data || [];
            },
            async update(table, id, dataToUpdate) { 
                if (!this.isConnected || !supabase) { showNotification('No hay conexión.', 'error'); return null; }
                const { id: recordId, ...updatePayload } = dataToUpdate;
                updatePayload.updated_at = new Date().toISOString(); 
                if (updatePayload.created_at) delete updatePayload.created_at; 
                const { data, error } = await supabase.from(this.config.tables[table]).update(updatePayload).eq('id', id).select();
                if (error) { console.error(`Error actualizando ${id} en ${table}:`, error); showNotification(`Error al actualizar: ${error.message}`, 'error'); return null; }
                return data?.[0];
            },
            async delete(table, id) {
                if (!this.isConnected || !supabase) { showNotification('No hay conexión.', 'error'); return false; }
                const { error } = await supabase.from(this.config.tables[table]).delete().eq('id', id);
                if (error) { console.error(`Error eliminando ${id} de ${table}:`, error); showNotification(`Error al eliminar: ${error.message}`, 'error'); return false; }
                return true;
            }
        };

        // --- Inicialización y Carga de Datos ---
        async function initializeApp() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedLanguage = localStorage.getItem('language') || 'es';
            setTheme(savedTheme);
            setLanguage(savedLanguage);
            const connected = await DatabaseManager.connect();
            if (connected) {
                await loadDataFromSupabase();
            } else {
                showNotification('No se pudo conectar a Supabase. Usando datos de muestra.', 'warning');
                loadSampleData(); 
                renderAllSections();
            }
            setupEventListeners();
            showSection(localStorage.getItem('lastSection') || 'home');
        }

        async function loadDataFromSupabase() {
            showNotification('Cargando datos desde Supabase...', 'info');
            try {
                folders = (await DatabaseManager.read('folders')).map(f => ({...f, id: f.id, name: f.name, created: new Date(f.created_at)})) || [];
                const notesData = await DatabaseManager.read('notes') || [];
                notes = notesData.map(n => ({
                    ...n, id: n.id, created: new Date(n.created_at), updated: new Date(n.updated_at)
                })).sort((a,b) => new Date(b.updated) - new Date(a.updated))
                   .sort((a,b) => (b.pinned ? 1 : 0) - (a.pinned ? 1: 0));
                if (notes.length > 0 && !currentNoteId) currentNoteId = notes[0].id;
                
                const filesData = await DatabaseManager.read('files') || [];
                files = filesData.map(f => ({
                    id: f.id, file_name: f.file_name, size: f.size, type: f.type, url: f.url, 
                    uploaded: new Date(f.uploaded_at || f.created_at), 
                })) || [];
                
                const eventsData = await DatabaseManager.read('events') || [];
                events = eventsData.map(e => ({
                    ...e, id: e.id, created: new Date(e.created_at), 
                    date: e.date && typeof e.date === 'string' ? e.date.split('T')[0] : new Date().toISOString().split('T')[0], 
                    description: e.description || '' 
                })) || [];
                
                console.log('Datos cargados desde Supabase:', { folders, notes, files, events });
                showNotification('Datos cargados exitosamente.', 'success');
            } catch (error) {
                console.error('Error al cargar datos desde Supabase:', error);
                showNotification('Error al cargar datos. Usando datos de muestra.', 'warning');
                loadSampleData();
            }
            renderAllSections();
        }

        function renderAllSections() {
            renderFolders();
            renderNotes();
            if (currentNoteId) selectNote(currentNoteId); else if (notes.length > 0) { currentNoteId = notes[0].id; selectNote(currentNoteId); }
            generateCalendar();
            renderFiles();
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- Manejo de Eventos UI ---
        function setupEventListeners() {
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('langToggle').addEventListener('click', toggleLanguage);
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(link.getAttribute('data-section'));
                });
            });
            document.getElementById('darkModeToggle').addEventListener('click', function() { this.classList.toggle('active'); toggleTheme(); });
            document.getElementById('fontSizeSelect').addEventListener('change', changeFontSize);
            document.getElementById('languageSelect').addEventListener('change', changeLanguage);
            
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            const dropZoneFiles = document.getElementById('dropZoneFiles');
            if (dropZoneFiles) {
                dropZoneFiles.addEventListener('click', () => triggerFileInput()); 
                dropZoneFiles.addEventListener('dragover', handleDragOver);
                dropZoneFiles.addEventListener('dragleave', handleDragLeave);
                dropZoneFiles.addEventListener('drop', handleDrop);
            }
            const dropZoneFolders = document.getElementById('dropZoneFolders'); 
            if (dropZoneFolders) {
                dropZoneFolders.addEventListener('dragover', handleDragOver);
                dropZoneFolders.addEventListener('dragleave', handleDragLeave);
                // dropZoneFolders.addEventListener('drop', handleDropInFolder); 
            }

            document.getElementById('fileSearch').addEventListener('input', searchFiles);
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => filterFiles(e.target.getAttribute('data-filter')));
            });
            document.getElementById('noteContent').addEventListener('input', autoSaveNote);
            document.getElementById('noteTitle').addEventListener('input', autoSaveNote);
            document.getElementById('summarizeNoteBtn').addEventListener('click', summarizeNoteWithGemini);
            document.getElementById('continueWritingBtn').addEventListener('click', continueWritingWithGemini);
            document.getElementById('suggestEventDetailsBtn').addEventListener('click', suggestEventDetailsWithGemini);
            document.getElementById('dailyTipBtn').addEventListener('click', showDailyTip);
            
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal') && !e.target.classList.contains('custom-confirm-modal-overlay')) { 
                    closeModal(e.target.id);
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active:not(.custom-confirm-modal-overlay)').forEach(modal => closeModal(modal.id));
                }
            });
        }

        // --- Lógica de Subida y Previsualización de Archivos ---
        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(e) {
            const selectedFile = e.target.files[0]; 
            if (selectedFile) {
                uploadAndPreviewSingleFile(selectedFile);
            }
            e.target.value = null; 
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const droppedFiles = Array.from(e.dataTransfer.files);
            
            if (droppedFiles.length > 0) {
                uploadAndPreviewSingleFile(droppedFiles[0]); 
                if (droppedFiles.length > 1) {
                    processMultipleFilesForStorage(droppedFiles.slice(1));
                }
            }
            document.getElementById('fileInput').value = null; 
        }

        async function uploadAndPreviewSingleFile(file) {
            if (!file) return;
            if (!DatabaseManager.isConnected || !supabase) {
                showNotification('Error: No hay conexión a Supabase. No se pueden subir archivos.', 'error');
                showNotification("Verifica tus políticas RLS en Supabase para el bucket 'archivos'.", "warning", 7000);
                return;
            }

            console.log(`Iniciando subida y previsualización para: ${file.name}`);
            GeminiAPIHelper.showLoading(); 

            try {
                const pathInBucket = `public/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
                
                console.log(`Subiendo a Supabase Storage: ${pathInBucket} con contentType: ${file.type}`);
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('archivos') 
                    .upload(pathInBucket, file, {
                        cacheControl: '3600', upsert: false, contentType: file.type 
                    });

                if (uploadError) {
                    console.error('Error subiendo a Supabase Storage:', uploadError);
                     if (uploadError.message && uploadError.message.includes('violates row-level security policy')) {
                         showNotification(`Error RLS al subir ${file.name}. Revisa las políticas de seguridad en Supabase.`, 'error', 10000); 
                    } else {
                        showNotification(`Error al subir ${file.name}: ${uploadError.message}`, 'error');
                    }
                    throw uploadError;
                }
                console.log('Archivo subido a Supabase Storage:', uploadData);

                const { data: urlData } = supabase.storage.from('archivos').getPublicUrl(pathInBucket);
                if (!urlData || !urlData.publicUrl) {
                    console.error('No se pudo obtener la URL pública después de la subida.');
                    showNotification(`Error al obtener URL pública para ${file.name}. Asegúrate que el bucket 'archivos' permita acceso público y las políticas RLS de SELECT estén correctas.`, 'error', 7000);
                    throw new Error('No se pudo obtener la URL pública del archivo.');
                }
                const publicUrl = urlData.publicUrl;
                console.log(`URL pública generada: ${publicUrl}`);

                const fileMetadata = {
                    file_name: file.name, size: file.size, type: file.type, url: publicUrl,
                };
                const createdFileInDB = await DatabaseManager.create('files', fileMetadata);
                if (!createdFileInDB || !createdFileInDB.id) {
                    console.error('Error guardando metadatos del archivo en la base de datos.');
                    throw new Error('Error al guardar información del archivo en la base de datos.');
                }
                console.log('Metadatos del archivo guardados en la base de datos:', createdFileInDB);

                const newFileObjectForUI = {
                    id: createdFileInDB.id, file_name: createdFileInDB.file_name,
                    size: createdFileInDB.size, type: createdFileInDB.type, 
                    url: createdFileInDB.url,
                    uploaded: new Date(createdFileInDB.uploaded_at || createdFileInDB.created_at),
                };
                files.unshift(newFileObjectForUI); 
                renderFiles(); 
                openFilePreviewModal(newFileObjectForUI);
                showNotification(`Archivo "${file.name}" subido y listo para previsualizar.`, 'success');
            } catch (error) {
                console.error(`Error en uploadAndPreviewSingleFile para ${file.name}:`, error);
            } finally {
                GeminiAPIHelper.hideLoading();
            }
        }

        async function processMultipleFilesForStorage(fileList) {
            let filesProcessedCount = 0;
            if (!fileList || fileList.length === 0) return;
            if (!DatabaseManager.isConnected || !supabase) {
                showNotification('Error: No hay conexión a Supabase. No se pueden subir archivos adicionales.', 'error');
                return;
            }
            showNotification(`Procesando ${fileList.length} archivo(s) adicionales...`, 'info');
            for (const file of fileList) {
                console.log(`Procesando archivo adicional para almacenamiento: ${file.name}`);
                try {
                    const pathInBucket = `public/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
                    const { error: uploadError } = await supabase.storage
                        .from('archivos').upload(pathInBucket, file, { contentType: file.type });
                    if (uploadError) throw uploadError;
                    const { data: urlData } = supabase.storage.from('archivos').getPublicUrl(pathInBucket);
                    if (!urlData?.publicUrl) throw new Error('No se pudo obtener URL pública para archivo adicional.');
                    const createdFileInDB = await DatabaseManager.create('files', {
                        file_name: file.name, size: file.size, type: file.type, url: urlData.publicUrl,
                    });
                    if (createdFileInDB) {
                        files.unshift({ ...createdFileInDB, id: createdFileInDB.id, uploaded: new Date(createdFileInDB.uploaded_at || createdFileInDB.created_at) });
                        filesProcessedCount++;
                    }
                } catch (error) {
                    console.error(`Error procesando archivo adicional ${file.name}:`, error);
                    showNotification(`Error con archivo adicional ${file.name}: ${error.message}`, 'error');
                }
            }
            renderFiles(); 
            if (filesProcessedCount > 0) {
                showNotification(`${filesProcessedCount} archivo(s) adicionales subidos.`, 'success');
            }
        }

        // --- Modal de Previsualización de Archivos (ACTUALIZADO CON PDF.js) ---
        function openFilePreviewModal(fileObject) {
            console.log("Abriendo previsualización para:", fileObject); 

            const modal = document.getElementById('filePreviewModal');
            const titleElement = document.getElementById('filePreviewTitle');
            const imgElement = document.getElementById('filePreviewImage');
            const videoElement = document.getElementById('filePreviewVideo');
            const audioElement = document.getElementById('filePreviewAudio');
            const pdfJsViewer = document.getElementById('filePreviewPdfJsViewer'); 
            const textElement = document.getElementById('filePreviewText');
            const fallbackElement = document.getElementById('filePreviewFallback');
            const downloadLink = document.getElementById('fileDownloadLink');

            [imgElement, videoElement, audioElement, pdfJsViewer, textElement, fallbackElement].forEach(el => {
                if (el) { 
                    el.style.display = 'none';
                    if (el.tagName === 'VIDEO' || el.tagName === 'AUDIO') el.pause();
                    if (el.tagName === 'IMG' || el.tagName === 'VIDEO' || el.tagName === 'AUDIO' || el.tagName === 'IFRAME') {
                        el.removeAttribute('src'); 
                    }
                    if (el.tagName === 'PRE') el.textContent = '';
                }
            });

            if (!fileObject || !fileObject.url || typeof fileObject.url !== 'string') {
                console.error("Objeto de archivo inválido o URL faltante:", fileObject);
                fallbackElement.textContent = 'No se pudo cargar el archivo: URL inválida o faltante.';
                fallbackElement.style.display = 'block';
                downloadLink.style.display = 'none';
                openModal('filePreviewModal');
                return;
            }
            
            titleElement.textContent = fileObject.file_name || 'Vista Previa de Archivo';
            let previewSrc = fileObject.url.replace(/^(https?:\/\/[^/]+)\/\//, '$1/');
            console.log("URL para previsualización (limpia):", previewSrc);
            console.log("Tipo de archivo (MIME type):", fileObject.type);

            downloadLink.href = previewSrc;
            downloadLink.download = fileObject.file_name || 'archivo_descargado';
            downloadLink.style.display = 'inline-block';

            let anElementWasSetToDisplay = false;
            const fileType = fileObject.type || '';

            if (fileType.startsWith('image/')) {
                imgElement.src = previewSrc; imgElement.style.display = 'block'; anElementWasSetToDisplay = true;
            } else if (fileType.startsWith('video/')) {
                videoElement.src = previewSrc; videoElement.style.display = 'block'; videoElement.load(); anElementWasSetToDisplay = true;
            } else if (fileType.startsWith('audio/')) {
                audioElement.src = previewSrc; audioElement.style.display = 'block'; audioElement.load(); anElementWasSetToDisplay = true;
            } else if (fileType.includes('pdf')) {
                console.log("Es un PDF, intentando mostrar con PDF.js en <iframe>. URL:", previewSrc);
                if (pdfJsViewer) {
                    const pdfJsUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(previewSrc)}`;
                    pdfJsViewer.src = pdfJsUrl;
                    pdfJsViewer.style.display = 'block';
                    anElementWasSetToDisplay = true;
                } else {
                    console.error("Elemento 'filePreviewPdfJsViewer' no encontrado en el DOM.");
                    fallbackElement.textContent = 'Error interno: Visor de PDF no encontrado.';
                    fallbackElement.style.display = 'block';
                }
            } else if (fileType.startsWith('text/')) {
                 fetch(previewSrc)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.text();
                    })
                    .then(text => {
                        textElement.textContent = text; textElement.style.display = 'block'; anElementWasSetToDisplay = true;
                    })
                    .catch(error => {
                        console.error("Error cargando archivo de texto desde URL:", error);
                        fallbackElement.textContent = `No se pudo cargar previsualización de texto. (Error: ${error.message})`;
                        fallbackElement.style.display = 'block';
                    });
            } else {
                fallbackElement.textContent = `No hay previsualización directa para este tipo de archivo (${fileType || 'desconocido'}). Intenta descargarlo.`;
                fallbackElement.style.display = 'block';
            }
            
            if (!anElementWasSetToDisplay && fallbackElement.style.display === 'none') {
                 fallbackElement.textContent = `No se pudo determinar un visor para este archivo (URL: ${previewSrc}, Tipo: ${fileType || 'desconocido'}).`;
                 fallbackElement.style.display = 'block';
            }
            openModal('filePreviewModal');
        }

        // --- Resto de funciones UI (showSection, themes, languages, modals, notifications, etc.) ---
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            const activeSection = document.getElementById(sectionName);
            if (activeSection) activeSection.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-link[data-section="${sectionName}"]`);
            if (activeLink) activeLink.classList.add('active');
            currentSection = sectionName;
            localStorage.setItem('lastSection', sectionName);
            if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('show')) {
                toggleSidebar();
            }
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('show'); 
            mainContent.classList.toggle('expanded', !sidebar.classList.contains('show') || sidebar.classList.contains('collapsed'));
        }
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            currentTheme = theme;
            const themeIcon = document.querySelector('#themeToggle i');
            const darkModeSwitch = document.getElementById('darkModeToggle');
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun'; 
                if (darkModeSwitch) darkModeSwitch.classList.add('active');
            } else {
                themeIcon.className = 'fas fa-moon'; 
                if (darkModeSwitch) darkModeSwitch.classList.remove('active');
            }
            localStorage.setItem('theme', theme);
        }
        function toggleTheme() { setTheme(currentTheme === 'dark' ? 'light' : 'dark'); }
        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('langToggle').innerHTML = `<i class="fas fa-globe"></i> ${lang.toUpperCase()}`;
            document.getElementById('languageSelect').value = lang;
            localStorage.setItem('language', lang);
            console.log(`Idioma cambiado a: ${lang}`);
        }
        function toggleLanguage() { setLanguage(currentLanguage === 'es' ? 'en' : 'es');}
        function changeLanguage(e) { setLanguage(e.target.value); }
        function changeFontSize(e) {
            const size = e.target.value;
            document.body.style.fontSize = size === 'small' ? '14px' : size === 'large' ? '18px' : '16px';
            localStorage.setItem('fontSize', size);
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                if (modalId === 'filePreviewModal') {
                    const videoElement = document.getElementById('filePreviewVideo');
                    const audioElement = document.getElementById('filePreviewAudio');
                    const pdfViewer = document.getElementById('filePreviewPdfJsViewer');
                    if (videoElement) { videoElement.pause(); videoElement.removeAttribute('src'); }
                    if (audioElement) { audioElement.pause(); audioElement.removeAttribute('src'); }
                    if (pdfViewer) { pdfViewer.removeAttribute('src'); } 
                }
            }
        }
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('active');
        }
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification slide-in ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.remove('slide-in');
                notification.classList.add('slide-out');
                setTimeout(() => notification.remove(), 500);
            }, duration);
        }
        function updateDbStatus(connected, message) {
            const dbStatusDiv = document.getElementById('dbStatus');
            const dbConnectionStatusSpan = document.getElementById('dbConnectionStatus'); 
            const iconClass = connected ? 'fa-check-circle' : 'fa-exclamation-triangle';
            const color = connected ? 'var(--success-color)' : 'var(--warning-color)';
            if (dbStatusDiv) {
                dbStatusDiv.className = `db-status ${connected ? 'connected' : ''}`;
                dbStatusDiv.innerHTML = `<div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas ${connected ? 'fa-database' : 'fa-exclamation-triangle'}"></i><span>${message}</span></div>`;
                dbStatusDiv.querySelector('i').style.color = connected ? 'var(--success-color)' : 'var(--warning-color)';
            }
            if (dbConnectionStatusSpan) {
                dbConnectionStatusSpan.innerHTML = `<i class="fas ${iconClass}" style="color: ${color};"></i> ${message}`;
                dbConnectionStatusSpan.style.color = color;
            }
        }

        // --- Funciones CRUD y renderizado para Files, Folders, Notes, Calendar ---
        function renderFiles() {
            const grid = document.getElementById('filesGrid');
            if(!grid) return;
            grid.innerHTML = ''; 
            const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active')?.getAttribute('data-filter') || 'all';
            const filteredAndSortedFiles = files.filter(file => {
                const nameMatch = file.file_name ? file.file_name.toLowerCase().includes(searchTerm) : false;
                if (!nameMatch) return false;
                if (activeFilter === 'all') return true;
                if (file.type) { 
                    if (activeFilter === 'image') return file.type.startsWith('image/');
                    if (activeFilter === 'document') return file.type.includes('pdf') || file.type.includes('word') || file.type.includes('document') || file.type.includes('excel') || file.type.includes('spreadsheet') || file.type.includes('text');
                    if (activeFilter === 'video') return file.type.startsWith('video/');
                    if (activeFilter === 'audio') return file.type.startsWith('audio/');
                }
                return false;
            }).sort((a,b) => new Date(b.uploaded || b.created_at) - new Date(a.uploaded || a.created_at)); 
            if (filteredAndSortedFiles.length === 0) {
                grid.innerHTML = `<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; padding: 1rem;">No hay archivos que coincidan.</p>`;
                return;
            }
            filteredAndSortedFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-item';
                const icon = getFileIcon(file.type);
                const size = formatFileSize(file.size);
                fileElement.innerHTML = `
                    <div class="file-icon" style="color: ${getFileColor(file.type)}"><i class="${icon}"></i></div>
                    <div class="file-name" title="${file.file_name}">${file.file_name}</div>
                    <div class="file-size">${size}</div>
                    <i class="fas fa-trash delete-file-icon" title="Eliminar archivo"></i>
                `;
                fileElement.querySelector('.delete-file-icon').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    deleteFileConfirmation(file.id, file.file_name, file.url);
                });
                fileElement.addEventListener('click', () => openFilePreviewModal(file));
                grid.appendChild(fileElement);
            });
        }
        function getFileIcon(type) { 
            if (!type) return 'fas fa-file';
            if (type.startsWith('image/')) return 'fas fa-file-image';
            if (type.startsWith('video/')) return 'fas fa-file-video';
            if (type.startsWith('audio/')) return 'fas fa-file-audio';
            if (type.includes('pdf')) return 'fas fa-file-pdf';
            if (type.includes('word') || type.includes('document')) return 'fas fa-file-word';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'fas fa-file-excel';
            return 'fas fa-file';
        }
        function getFileColor(type) { 
            if (!type) return 'var(--accent-color)';
            if (type.startsWith('image/')) return '#ff6b6b';
            if (type.startsWith('video/')) return '#4ecdc4';
            if (type.startsWith('audio/')) return '#45b7d1';
            if (type.includes('pdf')) return '#ff4757';
            if (type.includes('word')) return '#2e86de';
            if (type.includes('excel')) return '#1dd1a1';
            return 'var(--accent-color)';
        }
        function formatFileSize(bytes) { 
            if (bytes === undefined || bytes === null || isNaN(bytes) || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        function searchFiles() { renderFiles(); }
        function filterFiles(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.filter-btn[data-filter="${filter}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            renderFiles();
        }
        async function deleteFileConfirmation(fileId, fileName, fileUrl) {
            showCustomConfirm(`¿Eliminar "${fileName}"? También se intentará eliminar del almacenamiento.`, async () => {
                let storagePath = null;
                if (fileUrl && typeof fileUrl === 'string' && supabase) {
                    try {
                        const urlObj = new URL(fileUrl);
                        const pathParts = urlObj.pathname.split(`/storage/v1/object/public/archivos/`); 
                        if (pathParts.length > 1) {
                            storagePath = decodeURIComponent(pathParts[1]);
                            const { error: storageError } = await supabase.storage.from('archivos').remove([storagePath]);
                            if (storageError) console.error('Error eliminando de Storage:', storageError);
                            else console.log('Archivo eliminado de Storage.');
                        }
                    } catch (e) { console.error("Error al procesar URL/eliminar de Storage:", e); }
                }
                const dbSuccess = await DatabaseManager.delete('files', fileId);
                if (dbSuccess) {
                    files = files.filter(f => f.id !== fileId);
                    renderFiles(); 
                    showNotification(`"${fileName}" eliminado.`, 'success');
                } else {
                    showNotification(`Error al eliminar "${fileName}" de la DB.`, 'error');
                }
            });
        }
        function showCustomConfirm(message, onConfirm, onCancel) {
            const existingModal = document.querySelector('.custom-confirm-modal-overlay');
            if (existingModal) existingModal.remove();
            const overlay = document.createElement('div');
            overlay.className = 'modal active custom-confirm-modal-overlay'; 
            overlay.style.cssText = "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2001;";
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content'; 
            modalContent.style.maxWidth = '400px'; 
            modalContent.innerHTML = `
                <p style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.1rem; line-height: 1.5;">${message}</p>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button class="btn btn-secondary" id="customConfirmCancelBtnModal">Cancelar</button>
                    <button class="btn" id="customConfirmOkBtnModal" style="background-color: var(--danger-color);">Confirmar</button>
                </div>`; 
            overlay.appendChild(modalContent);
            document.body.appendChild(overlay);
            document.getElementById('customConfirmOkBtnModal').onclick = () => { if (onConfirm) onConfirm(); overlay.remove(); };
            document.getElementById('customConfirmCancelBtnModal').onclick = () => { if (onCancel) onCancel(); overlay.remove(); };
        }
        
        function createFolder() { openModal('folderModal'); }
        async function confirmCreateFolder() { 
            const name = document.getElementById('folderNameInput').value.trim();
            if (!name) { showNotification("Nombre de carpeta vacío.", "warning"); return; }
            const createdFolder = await DatabaseManager.create('folders', { name });
            if (createdFolder) {
                folders.push({ ...createdFolder, created: new Date(createdFolder.created_at) });
                renderFolders(); closeModal('folderModal'); document.getElementById('folderNameInput').value = '';
                showNotification('Carpeta creada.', 'success');
            }
        }
        function renderFolders() { 
            const grid = document.getElementById('foldersGrid'); if (!grid) return; grid.innerHTML = '';
            folders.sort((a, b) => new Date(b.created) - new Date(a.created));
            if (folders.length === 0) { grid.innerHTML = `<p style="color: var(--text-secondary); text-align:center; padding:1rem;">No hay carpetas.</p>`; return; }
            folders.forEach(folder => {
                const item = document.createElement('div'); item.className = 'folder-item';
                item.innerHTML = `<div class="folder-icon"><i class="fas fa-folder"></i></div><div class="folder-name">${folder.name}</div><div class="folder-stats">0 archivos</div>`;
                item.addEventListener('click', () => openFolder(folder.id)); grid.appendChild(item);
            });
        }
        function openFolder(folderId) { console.log("Abrir carpeta (no implementado):", folderId); showNotification("Funcionalidad de abrir carpeta no implementada.", "info");}

        async function createNote() { 
            const createdNote = await DatabaseManager.create('notes', { title: 'Nueva Nota', content: '', pinned: false });
            if (createdNote) {
                const fullNote = { ...createdNote, created: new Date(createdNote.created_at), updated: new Date(createdNote.updated_at) };
                notes.unshift(fullNote); currentNoteId = fullNote.id; renderNotes(); selectNote(fullNote.id);
                showNotification('Nota creada.', 'success');
            }
        }
        function renderNotes() { 
            const listEl = document.getElementById('notesList'); if (!listEl) return; listEl.innerHTML = '';
            notes.sort((a,b) => new Date(b.updated) - new Date(a.updated)).sort((a,b) => (b.pinned ? 1:0) - (a.pinned ? 1:0));
            if (notes.length === 0) { listEl.innerHTML = `<p style="color:var(--text-secondary);text-align:center;padding:1rem;">No hay notas.</p>`; document.getElementById('noteTitle').value=''; document.getElementById('noteContent').value=''; return; }
            notes.forEach(note => {
                const item = document.createElement('div'); item.className = `note-item ${currentNoteId === note.id ? 'active':''}`;
                item.setAttribute('data-note-id', note.id);
                item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><strong title="${note.title}">${note.title?.substring(0,25)||"Sin Título"}${note.title && note.title.length > 25 ? '...':''}</strong><div><i class="fas fa-thumbtack pin-note" style="color:${note.pinned ? 'var(--accent-color)':'var(--text-secondary)'};cursor:pointer;margin-right:8px;font-size:0.9em;" title="Fijar"></i><i class="fas fa-trash delete-note-icon" style="color:var(--text-secondary);cursor:pointer;font-size:0.9em;" title="Eliminar"></i></div></div><div style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${note.content?.substring(0,40)||"<i>Vacía...</i>"}${note.content && note.content.length > 40 ? '...':''}</div>`;
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('pin-note')) { e.stopPropagation(); togglePinNote(note.id); }
                    else if (e.target.classList.contains('delete-note-icon')) { e.stopPropagation(); deleteNoteConfirmation(note.id); }
                    else { selectNote(note.id); }
                });
                listEl.appendChild(item);
            });
        }
        function selectNote(noteId) { 
            currentNoteId = noteId; const note = notes.find(n=>n.id===noteId);
            document.getElementById('noteTitle').value = note ? note.title:''; document.getElementById('noteContent').value = note ? note.content:'';
            document.querySelectorAll('.note-item').forEach(i=>i.classList.remove('active'));
            document.querySelector(`.note-item[data-note-id="${noteId}"]`)?.classList.add('active');
        }
        async function saveNote(showNotif=true) { 
            if (!currentNoteId) { if(showNotif) showNotification("No hay nota seleccionada.", "warning"); return; }
            const noteIndex = notes.findIndex(n=>n.id===currentNoteId);
            if (noteIndex > -1) {
                const dataToUpdate = {title:document.getElementById('noteTitle').value.trim()||'Nota sin título', content:document.getElementById('noteContent').value};
                const updatedDB = await DatabaseManager.update('notes', currentNoteId, dataToUpdate);
                if (updatedDB) {
                    notes[noteIndex] = {...notes[noteIndex], ...updatedDB, updated:new Date(updatedDB.updated_at)};
                    renderNotes(); selectNote(currentNoteId); if(showNotif) showNotification('Nota guardada.','success');
                }
            }
        }
        function autoSaveNote(){clearTimeout(window.autoSaveTimeout);window.autoSaveTimeout=setTimeout(()=>saveNote(false),1500);}
        async function deleteNote(){if(currentNoteId)deleteNoteConfirmation(currentNoteId);else showNotification("No hay nota seleccionada.","warning");}
        function deleteNoteConfirmation(noteId){showCustomConfirm("¿Eliminar esta nota?",async()=>{const s=await DatabaseManager.delete('notes',noteId);if(s){notes=notes.filter(n=>n.id!==noteId);if(currentNoteId===noteId){currentNoteId=notes.length>0?notes[0].id:null;if(currentNoteId)selectNote(currentNoteId);else{document.getElementById('noteTitle').value='';document.getElementById('noteContent').value='';}}renderNotes();showNotification('Nota eliminada.','success');}});}
        async function togglePinNote(noteId){const i=notes.findIndex(n=>n.id===noteId);if(i>-1){const p=!notes[i].pinned;const u=await DatabaseManager.update('notes',noteId,{pinned:p});if(u){notes[i].pinned=p;notes[i].updated=new Date(u.updated_at);renderNotes();}}}
        function formatText(c){console.warn(`formatText('${c}') no implementado.`);}
        function insertList(){console.warn("insertList no implementado.");}
        async function summarizeNoteWithGemini(){if(!currentNoteId){showNotification('Selecciona nota.','warning');return;}const n=notes.find(i=>i.id===currentNoteId);if(!n||!n.content?.trim()){showNotification('Nota vacía.','warning');return;}const p=`Resume el siguiente texto en español:\n\n"${n.content}"\n\nResumen:`;const s=await GeminiAPIHelper.generateText(p);if(s){const r=await DatabaseManager.create('notes',{title:`Resumen de: ${n.title}`,content:s,pinned:false});if(r){notes.unshift({...r,created:new Date(r.created_at),updated:new Date(r.updated_at)});renderNotes();selectNote(r.id);showNotification('Resumen guardado.','success');}}}
        async function continueWritingWithGemini(){if(!currentNoteId){showNotification('Selecciona nota.','warning');return;}const c=document.getElementById('noteContent').value;const p=`Continúa el texto:\n\n"${c}"\n\nAdicional:`;const t=await GeminiAPIHelper.generateText(p);if(t){document.getElementById('noteContent').value+=`\n\n${t.trim()}`;await saveNote(false);showNotification('Texto continuado.','success');}}
        async function suggestEventDetailsWithGemini(){const t=document.getElementById('eventTitleInput').value.trim();if(!t){showNotification('Ingresa título.','warning');return;}const p=`Descripción para evento "${t}":`;const s=await GeminiAPIHelper.generateText(p);if(s){document.getElementById('eventDescriptionInput').value=s.trim();showNotification('Descripción sugerida.','success');}}
        const dailyPhrases=["La sonrisa es el idioma universal.","Ama lo que haces.","Sigue adelante.","Cree en ti."];function showDailyTip(){const t=dailyPhrases[Math.floor(Math.random()*dailyPhrases.length)];document.getElementById('tipModalContent').textContent=t;openModal('tipModal');}

        function generateCalendar() { 
            const grid=document.getElementById('calendarGrid');
            const title=document.getElementById('calendarTitle');
            if(!grid || !title) return;

            const months=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            title.textContent=`${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            grid.innerHTML=''; // Limpiar calendario

            // Encabezados de días de la semana
            ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'].forEach(dayName => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day calendar-header-day';
                dayHeader.textContent = dayName;
                grid.appendChild(dayHeader);
            });

            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 (Dom) - 6 (Sáb)

            // Celdas vacías para los días antes del inicio del mes
            for(let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                grid.appendChild(emptyCell);
            }

            const today = new Date();
            // Celdas para cada día del mes
            for(let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                dayCell.dataset.day = day; // Usar dataset para almacenar el día

                if(today.getDate() === day && 
                   today.getMonth() === currentDate.getMonth() && 
                   today.getFullYear() === currentDate.getFullYear()) {
                    dayCell.classList.add('today');
                }
                
                // Lógica para marcar eventos (asumiendo que 'events' es un array de objetos evento)
                const dayEvents = events.filter(event => {
                    if (!event.date) return false;
                    const eventDate = new Date(event.date + 'T00:00:00'); // Normalizar para comparar solo fecha
                    return eventDate.getFullYear() === currentDate.getFullYear() &&
                           eventDate.getMonth() === currentDate.getMonth() &&
                           eventDate.getDate() === day;
                });

                if(dayEvents.length > 0) {
                    dayCell.classList.add('has-events');
                    const eventIndicator = document.createElement('span');
                    eventIndicator.className = 'event-indicator';
                    eventIndicator.title = `${dayEvents.length} evento(s)`;
                    dayCell.appendChild(eventIndicator);
                }
                dayCell.addEventListener('click', () => selectDate(day));
                grid.appendChild(dayCell);
            }
        }
        function previousMonth(){currentDate.setMonth(currentDate.getMonth()-1);generateCalendar();}
        function nextMonth(){currentDate.setMonth(currentDate.getMonth()+1);generateCalendar();}
        function todayView(){currentDate=new Date();generateCalendar();}
        function selectDate(day){const s=new Date(currentDate.getFullYear(),currentDate.getMonth(),day);document.getElementById('eventDateInput').valueAsDate=s;document.getElementById('eventTitleInput').value='';document.getElementById('eventDescriptionInput').value='';document.getElementById('eventTimeInput').value='';openModal('eventModal');}
        function addEvent(){document.getElementById('eventTitleInput').value='';document.getElementById('eventDescriptionInput').value='';document.getElementById('eventDateInput').valueAsDate=new Date();document.getElementById('eventTimeInput').value='';openModal('eventModal');}
        async function confirmAddEvent(){const t=document.getElementById('eventTitleInput').value.trim();const d=document.getElementById('eventDateInput').value;const m=document.getElementById('eventTimeInput').value;const ds=document.getElementById('eventDescriptionInput').value.trim();if(!t||!d){showNotification('Título y fecha requeridos.','warning');return;}const cE=await DatabaseManager.create('events',{title:t,date:d,time:m||null,description:ds});if(cE){events.push({...cE,created:new Date(cE.created_at),date:cE.date.split('T')[0]});generateCalendar();closeModal('eventModal');showNotification('Evento creado.','success');}}
        function showDatabaseConfig(){openModal('databaseModal');}
        function toggleView(){const gC=document.getElementById('foldersGrid');const vI=document.getElementById('viewIcon');if(gC&&vI){gC.classList.toggle('list-view');vI.classList.toggle('fa-th');vI.classList.toggle('fa-list');document.getElementById('filesGrid')?.classList.toggle('list-view',gC.classList.contains('list-view'));}}
        function loadSampleData(){folders=[{id:'s1',name:'Docs (Muestra)',created:new Date()}];notes=[{id:'s2',title:'Bienvenida',content:'Organiza tus ideas.',created:new Date(),updated:new Date(),pinned:true}];files=[{id:'s3',file_name:"ejemplo.pdf",size:102400,type:"application/pdf",uploaded:new Date(),url:"#"}];events=[{id:'s4',title:'Reunión',date:new Date().toISOString().split('T')[0],time:'10:00',description:'Objetivos.',created:new Date()}];if(notes.length>0)currentNoteId=notes[0].id;console.log("Datos de muestra cargados.");}
        function updateDateTime() { /* Placeholder */ }

        console.log('Mi Espacio Inteligente - Aplicación cargada y lista.');
    </script>
</body>
</html>

